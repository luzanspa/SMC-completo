<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCEL - Sistema de Cadastro de Exames Laboratoriais</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #ffd700;
      --secondary: #ff8c00;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --light: rgba(255, 255, 255, 0.98);
      --shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
      --radius: 16px;
      --transition: all 0.3s ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }
    
    .header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 10px;
      text-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .card {
      background: var(--light);
      backdrop-filter: blur(20px);
      padding: 30px;
      margin-bottom: 30px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .card:hover { transform: translateY(-2px); }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    input, textarea, select {
      padding: 12px 16px;
      border: 2px solid #e8ecef;
      border-radius: 8px;
      font-size: 14px;
      transition: var(--transition);
      background: #fafbfc;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.15);
    }
    
    .btn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #333;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      text-transform: uppercase;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #c82333);
      color: white;
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success), #1e7e34);
      color: white;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      min-width: 32px;
      height: 32px;
    }
    
    .search-bar {
      display: flex;
      gap: 15px;
      align-items: end;
    }
    
    .search-bar .form-group { flex: 1; }
    
    .table-container {
      background: var(--light);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #333;
      padding: 15px 12px;
      font-weight: 600;
      text-align: left;
      font-size: 0.85rem;
      text-transform: uppercase;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.85rem;
    }
    
    tr:hover {
      background: rgba(255, 215, 0, 0.1);
    }
    
    .actions {
      display: flex;
      gap: 5px;
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
    }

    .toast {
      background: white;
      border-radius: 8px;
      padding: 15px 20px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-left: 4px solid var(--success);
      min-width: 300px;
      animation: slideIn 0.3s ease;
    }

    .toast.error { border-left-color: var(--danger); }
    .toast.warning { border-left-color: var(--warning); }
    .toast.info { border-left-color: var(--info); }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .exame-item {
      display: flex;
      align-items: center;
      padding: 4px 6px;
      margin: 1px 0;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #e0e0e0;
      background: white;
      font-size: 11px;
    }

    .exame-item:hover {
      background: rgba(255, 215, 0, 0.1);
      border-color: var(--primary);
    }

    .exame-item.selecionado {
      background: linear-gradient(135deg, var(--success), #20c997);
      border-color: var(--success);
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
      transform: translateY(-1px);
    }

    .exame-item.selecionado .exame-codigo {
      background: rgba(255, 255, 255, 0.9);
      color: var(--success);
      font-weight: 700;
    }

    .exame-item.selecionado::after {
      content: '‚úì';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      font-weight: bold;
      color: white;
    }

    .exame-item {
      position: relative;
    }

    .exame-codigo {
      background: var(--primary);
      color: #333;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 600;
      margin-right: 5px;
      min-width: 35px;
      text-align: center;
    }

    .exame-nome {
      flex: 1;
      font-size: 10px;
    }

    .exame-tag {
      display: inline-block;
      background: var(--primary);
      color: #333;
      padding: 4px 8px;
      margin: 2px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .exames-selecionados {
      padding: 10px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 6px;
      min-height: 40px;
    }

    .exames-modal-container {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 10px;
      background: #fafafa;
    }

    .exames-modal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 12px;
    }

    .categoria-section {
      break-inside: avoid;
    }

    .categoria-exames {
      font-weight: 600;
      color: #666;
      font-size: 12px;
      margin: 8px 0 4px 0;
      text-transform: uppercase;
      border-bottom: 1px solid #eee;
      padding-bottom: 2px;
      grid-column: 1 / -1;
    }

    @media (max-width: 768px) {
      .exames-modal-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 1200px) and (min-width: 1025px) {
      .exames-modal-grid {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }

    @media (max-width: 1024px) and (min-width: 769px) {
      .exames-modal-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background: white;
      margin: 10% auto;
      padding: 30px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow);
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover { color: #000; }

    .historico-cns {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .historico-item {
      padding: 10px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .historico-item:hover {
      background: rgba(255, 215, 0, 0.1);
    }
    
    .historico-item:last-child {
      border-bottom: none;
    }
    
    .historico-nome {
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
    }
    
    .historico-detalhes {
      font-size: 0.8rem;
      color: #666;
      margin-top: 2px;
    }
    
    .form-group {
      position: relative;
    }

    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
      .search-bar { flex-direction: column; }
      .header h1 { font-size: 2rem; }
      body { padding: 10px; }
    }
    
    /* Estilos para impress√£o - continua√ß√£o */
    @media print {
      .exame-item { font-size: 10px !important; }
      .metric-card div:first-child { font-size: 1.5rem !important; }
    }
    
    /* Otimiza√ß√µes de performance */
    .exame-item, .historico-item {
      will-change: transform;
    }
    
    /* Melhorias de acessibilidade */
    .btn:focus, input:focus, select:focus, textarea:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    /* Loading states */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid var(--primary);
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Estilos para impress√£o completos */
    @media print {
      body { background: white !important; }
      .modal { position: static !important; background: white !important; }
      .modal-content { 
        max-width: 100% !important; 
        width: 100% !important; 
        height: auto !important; 
        margin: 0 !important; 
        padding: 15px !important;
        background: white !important;
        color: black !important;
        box-shadow: none !important;
        border-radius: 0 !important;
      }
      .close, .btn { display: none !important; }
      .chart-section, .metric-card, .dark-card {
        background: white !important;
        color: black !important;
        border: 1px solid #ddd !important;
        box-shadow: none !important;
        page-break-inside: avoid;
      }
      h1, h2, h3 { color: black !important; }
      .metric-card { 
        background: #f8f9fa !important;
        border: 2px solid #333 !important;
        margin-bottom: 10px !important;
      }
      #estatisticasContent {
        font-size: 11px !important;
        line-height: 1.3 !important;
      }
      .chart-section h3 {
        font-size: 12px !important;
        margin-bottom: 8px !important;
      }
      /* Ajustar grid para impress√£o */
      #estatisticasContent > div {
        grid-template-columns: 1fr 1fr !important;
        gap: 10px !important;
      }
      /* Compactar elementos */
      .metric-card div:first-child {
        font-size: 1.8rem !important;
      }
      .chart-section {
        padding: 10px !important;
        margin-bottom: 8px !important;
      }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>
  
  <div class="container">
    <div class="header">
      <h1>üè• SCEL</h1>
      <p>Sistema de Cadastro de Exames Laboratoriais</p>
      <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button class="btn btn-small" onclick="exportarExcel()" title="Exportar dados (Ctrl+E)">üìà Exportar Excel</button>
        <button class="btn btn-small" onclick="document.getElementById('importFile').click()" title="Importar dados">üìÅ Importar Excel</button>
        <button class="btn btn-small" onclick="abrirEstatisticas()" title="Ver estat√≠sticas (Ctrl+D)">üìä Estat√≠sticas</button>
        <button class="btn btn-small" onclick="mostrarAjuda()" title="Ajuda e atalhos">‚ùì Ajuda</button>
        <input type="file" id="importFile" accept=".xlsx,.xls" style="display: none;" onchange="importarExcel(event)">
      </div>
    </div>

    <div class="card">
      <h2 style="margin-bottom: 20px; color: #333;">üìã Cadastro de Paciente</h2>
      <form id="pacienteForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="nome">Nome Completo *</label>
            <input type="text" id="nome" required>
          </div>
          <div class="form-group">
            <label for="cpf">CNS/CPF *</label>
            <input type="text" id="cpf" required maxlength="18" placeholder="CNS: 000 0000 0000 0000 ou CPF: 000.000.000-00" autocomplete="off">
            <div id="historicoCns" class="historico-cns"></div>
          </div>
          <div class="form-group">
            <label for="dataNascimento">Data de Nascimento *</label>
            <input type="date" id="dataNascimento" required>
          </div>
          <div class="form-group">
            <label for="telefone">Telefone</label>
            <input type="tel" id="telefone" placeholder="(00) 00000-0000">
          </div>
          <div class="form-group">
            <label for="genero">G√™nero *</label>
            <select id="genero" required onchange="toggleOutroGenero()">
              <option value="">Selecione...</option>
              <option value="masculino">Homem</option>
              <option value="feminino">Mulher</option>
              <option value="outro">Outro</option>
            </select>
          </div>
          <div class="form-group" id="outroGeneroDiv" style="display: none;">
            <label for="outroGenero">Especificar G√™nero</label>
            <input type="text" id="outroGenero" placeholder="Digite o g√™nero...">
          </div>
          <div class="form-group">
            <label for="laboratorio">Laborat√≥rio *</label>
            <select id="laboratorio" required>
              <option value="">Selecione...</option>
              <option value="apolo">Apolo</option>
              <option value="queiroz">Queiroz</option>
              <option value="sao_lourenco">S√£o Louren√ßo</option>
            </select>
          </div>
        </div>
        
        <div class="form-group" style="grid-column: 1 / -1;">
          <label for="endereco">Endere√ßo Completo *</label>
          <input type="text" id="endereco" placeholder="Rua, n√∫mero, bairro, cidade, CEP" required>
        </div>

        <div class="form-group">
          <label for="exames">Exames Solicitados *</label>
          <button type="button" class="btn" onclick="abrirModalExames()" style="width: 100%; margin-bottom: 10px;">
            üìã Selecionar Exames
          </button>
          <div class="exames-selecionados" id="examesSelecionados">
            <small style="color: #666;">Nenhum exame selecionado</small>
          </div>
        </div>

        <div style="margin-top: 20px;" id="botoesFormulario">
          <button type="submit" class="btn btn-success" id="btnCadastrar" title="Cadastrar paciente (Ctrl+S)">üíæ Cadastrar</button>
          <div id="botoesEdicao" style="display: none; gap: 15px;">
            <button type="submit" class="btn btn-success" title="Salvar altera√ß√µes (Ctrl+S)">üíæ Salvar</button>
            <button type="button" class="btn" onclick="cancelarEdicao()" title="Cancelar edi√ß√£o (ESC)">‚ùå Cancelar</button>
          </div>
        </div>
      </form>
    </div>

    <div class="card">
      <h2 style="margin-bottom: 15px; color: #333;">üîç Buscar Pacientes</h2>
      <div class="form-group">
        <label for="busca">Buscar em todos os campos</label>
        <input type="text" id="busca" placeholder="Digite qualquer informa√ß√£o do paciente... (F3 para focar)" oninput="buscarPacientes()" title="Buscar pacientes (F3 para focar)">
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="min-width: 90px;">Data Cadastro</th>
            <th>Nome</th>
            <th>CNS/CPF</th>
            <th style="min-width: 100px;">Data Nascimento</th>
            <th>Telefone</th>
            <th style="min-width: 80px;">G√™nero</th>
            <th>Laborat√≥rio</th>
            <th>Endere√ßo</th>
            <th>Exames</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaPacientes">
          <tr>
            <td colspan="6" style="text-align: center; color: #666; padding: 30px;">
              Nenhum paciente cadastrado
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal de Sele√ß√£o de Exames -->
  <div id="modalExames" class="modal">
    <div class="modal-content" style="max-width: 900px; width: 90%;">
      <span class="close" onclick="fecharModalExames()">&times;</span>
      <h2>üìã Selecionar Exames</h2>

      <div class="exames-modal-container">
        <div class="exames-modal-grid" id="examesModalGrid">
          <!-- Exames ser√£o carregados aqui -->
        </div>
      </div>
      <div style="display: flex; gap: 15px; margin-top: 20px; justify-content: center;">
        <button type="button" class="btn btn-success" onclick="confirmarExames()">‚úì Confirmar Sele√ß√£o</button>
        <button type="button" class="btn" onclick="fecharModalExames()">‚ùå Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal Dashboard -->
  <div id="modalEstatisticas" class="modal">
    <div class="modal-content" style="max-width: 100vw; width: 100vw; height: 100vh; max-height: 100vh; margin: 0; padding: 20px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); color: white; border: none; border-radius: 0; overflow-y: auto;">
      <div style="position: absolute; top: 15px; right: 25px; z-index: 1000; display: flex; gap: 10px; align-items: center;">
        <select id="mesFiltro" onchange="atualizarDashboard()" style="padding: 5px 10px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.3); background: white; color: #333; font-size: 12px;">
          <option value="todos">Todos os Meses</option>
        </select>
        <button class="btn btn-small" onclick="imprimirDashboard()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">üñ®Ô∏è Imprimir</button>
        <span class="close" onclick="fecharEstatisticas()" style="color: white; font-size: 28px; cursor: pointer;">&times;</span>
      </div>
      <h1 style="text-align: center; margin-bottom: 25px; color: white; font-size: 1.6rem; font-weight: bold; text-transform: uppercase; letter-spacing: 2px;">üè• DASHBOARD ACOMPANHAMENTO SCEL</h1>
      <div id="estatisticasContent">
        <!-- Dashboard ser√° carregado aqui -->
      </div>
    </div>
  </div>

  <div id="modalEdicao" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal()">&times;</span>
      <h2>‚úèÔ∏è Editar Paciente</h2>
      <form id="formEdicao">
        <div class="form-group">
          <label for="editNome">Nome Completo</label>
          <input type="text" id="editNome" required>
        </div>
        <div class="form-group">
          <label for="editTelefone">Telefone</label>
          <input type="tel" id="editTelefone">
        </div>
        <div class="form-group">
          <label for="editGenero">G√™nero</label>
          <select id="editGenero" onchange="toggleEditOutroGenero()">
            <option value="">Selecione...</option>
            <option value="masculino">Homem</option>
            <option value="feminino">Mulher</option>
            <option value="outro">Outro</option>
          </select>
        </div>
        <div class="form-group" id="editOutroGeneroDiv" style="display: none;">
          <label for="editOutroGenero">Especificar G√™nero</label>
          <input type="text" id="editOutroGenero" placeholder="Digite o g√™nero...">
        </div>
        <div style="display: flex; gap: 15px; margin-top: 15px;">
          <button type="submit" class="btn btn-success">üíæ Salvar</button>
          <button type="button" class="btn" onclick="fecharModal()">‚ùå Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Ajuda -->
  <div id="modalAjuda" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <span class="close" onclick="fecharModalAjuda()">&times;</span>
      <h2 style="text-align: center; color: var(--primary); margin-bottom: 25px;">üî• GUIA R√ÅPIDO SCEL</h2>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <h3 style="color: var(--secondary); margin-bottom: 10px;">‚å®Ô∏è ATALHOS DE TECLADO</h3>
          <div style="font-size: 0.9rem; line-height: 1.6;">
            <div><strong>Ctrl + S</strong> = Salvar/Cadastrar</div>
            <div><strong>Ctrl + E</strong> = Exportar Excel</div>
            <div><strong>Ctrl + D</strong> = Dashboard</div>
            <div><strong>F3</strong> = Focar na busca</div>
            <div><strong>ESC</strong> = Fechar modais</div>
            <div><strong>‚Üë‚Üì</strong> = Navegar hist√≥rico CNS</div>
            <div><strong>Enter</strong> = Selecionar do hist√≥rico</div>
          </div>
        </div>
        
        <div>
          <h3 style="color: var(--secondary); margin-bottom: 10px;">üñ±Ô∏è FUNCIONALIDADES</h3>
          <div style="font-size: 0.9rem; line-height: 1.6;">
            <div>‚Ä¢ Digite 3+ d√≠gitos no CNS para ver hist√≥rico</div>
            <div>‚Ä¢ Busca em tempo real em todos os campos</div>
            <div>‚Ä¢ Backup autom√°tico a cada altera√ß√£o</div>
            <div>‚Ä¢ Valida√ß√£o de CNS/CPF duplicado</div>
            <div>‚Ä¢ Estat√≠sticas avan√ßadas com filtros</div>
            <div>‚Ä¢ Formata√ß√£o autom√°tica CNS/CPF</div>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 20px; padding: 15px; background: rgba(255, 215, 0, 0.1); border-radius: 8px;">
        <h3 style="color: var(--secondary); margin-bottom: 10px;">üí° DICAS IMPORTANTES</h3>
        <div style="font-size: 0.9rem; line-height: 1.6;">
          <div>‚Ä¢ <strong>CNS priorit√°rio:</strong> Sistema formata automaticamente como CNS (15 d√≠gitos)</div>
          <div>‚Ä¢ <strong>Backups regulares:</strong> Use Exportar Excel frequentemente</div>
          <div>‚Ä¢ <strong>Filtros dashboard:</strong> Selecione m√™s espec√≠fico para an√°lises</div>
          <div>‚Ä¢ <strong>Importa√ß√£o:</strong> Verifique dados antes de importar (a√ß√£o irrevers√≠vel)</div>
          <div>‚Ä¢ <strong>Duplica√ß√£o permitida:</strong> Mesmo paciente pode ter m√∫ltiplos cadastros</div>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
        <button class="btn btn-success" onclick="abrirManualCompleto()">üìö Manual Completo</button>
        <button class="btn" onclick="fecharModalAjuda()">‚úÖ Entendi</button>
      </div>
    </div>
  </div>

  <!-- Modal Manual Completo -->
  <div id="modalManual" class="modal">
    <div class="modal-content" style="max-width: 90vw; width: 90vw; height: 90vh; max-height: 90vh; margin: 2.5vh auto; overflow-y: auto;">
      <span class="close" onclick="fecharModalManual()">&times;</span>
      <h1 style="text-align: center; color: var(--primary); margin-bottom: 30px;">üìö MANUAL DO USU√ÅRIO - SCEL</h1>
      
      <div style="display: grid; grid-template-columns: 250px 1fr; gap: 30px; height: calc(100% - 80px);">
        <!-- √çndice -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; height: fit-content; position: sticky; top: 0;">
          <h3 style="color: var(--secondary); margin-bottom: 15px;">üìã √çNDICE</h3>
          <div style="font-size: 0.9rem; line-height: 2;">
            <a href="#intro" onclick="scrollToSection('intro')" style="color: var(--secondary); text-decoration: none; display: block;">1. Introdu√ß√£o</a>
            <a href="#cadastro" onclick="scrollToSection('cadastro')" style="color: var(--secondary); text-decoration: none; display: block;">2. Cadastro de Pacientes</a>
            <a href="#busca" onclick="scrollToSection('busca')" style="color: var(--secondary); text-decoration: none; display: block;">3. Sistema de Busca</a>
            <a href="#exames" onclick="scrollToSection('exames')" style="color: var(--secondary); text-decoration: none; display: block;">4. Sele√ß√£o de Exames</a>
            <a href="#edicao" onclick="scrollToSection('edicao')" style="color: var(--secondary); text-decoration: none; display: block;">5. Edi√ß√£o e Exclus√£o</a>
            <a href="#dashboard" onclick="scrollToSection('dashboard')" style="color: var(--secondary); text-decoration: none; display: block;">6. Dashboard</a>
            <a href="#backup" onclick="scrollToSection('backup')" style="color: var(--secondary); text-decoration: none; display: block;">7. Backup e Importa√ß√£o</a>
            <a href="#atalhos" onclick="scrollToSection('atalhos')" style="color: var(--secondary); text-decoration: none; display: block;">8. Atalhos de Teclado</a>
            <a href="#dicas" onclick="scrollToSection('dicas')" style="color: var(--secondary); text-decoration: none; display: block;">9. Dicas Avan√ßadas</a>
          </div>
        </div>
        
        <!-- Conte√∫do -->
        <div style="padding-right: 20px;">
          <!-- 1. Introdu√ß√£o -->
          <section id="intro" style="margin-bottom: 40px;">
            <h2 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px;">1. üè• Introdu√ß√£o ao SCEL</h2>
            <p style="margin: 15px 0; line-height: 1.6;">O <strong>Sistema de Cadastro de Exames Laboratoriais (SCEL)</strong> √© uma ferramenta completa para gest√£o de pacientes e exames m√©dicos. Desenvolvido para ser intuitivo e eficiente, oferece recursos avan√ßados de cadastro, busca, estat√≠sticas e backup.</p>
            <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
              <strong>üéØ Principais Funcionalidades:</strong>
              <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                <li>Cadastro completo de pacientes com valida√ß√µes</li>
                <li>Sele√ß√£o de exames por categorias</li>
                <li>Busca avan√ßada em tempo real</li>
                <li>Dashboard com estat√≠sticas detalhadas</li>
                <li>Sistema de backup autom√°tico</li>
                <li>Hist√≥rico inteligente de CNS</li>
              </ul>
            </div>
          </section>
          
          <!-- 2. Cadastro -->
          <section id="cadastro" style="margin-bottom: 40px;">
            <h2 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px;">2. üìã Cadastro de Pacientes</h2>
            <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">Campos Obrigat√≥rios:</h3>
            <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li><strong>Nome Completo:</strong> M√≠nimo 2 caracteres, convertido automaticamente para mai√∫sculas</li>
              <li><strong>CNS/CPF:</strong> Aceita CNS (15 d√≠gitos) ou CPF (11 d√≠gitos) com formata√ß√£o autom√°tica</li>
              <li><strong>Data de Nascimento:</strong> Validada para idades entre 0-120 anos</li>
              <li><strong>G√™nero:</strong> Op√ß√µes pr√©-definidas ou campo livre para "Outro"</li>
              <li><strong>Laborat√≥rio:</strong> Apolo, Queiroz ou S√£o Louren√ßo</li>
              <li><strong>Endere√ßo:</strong> M√≠nimo 10 caracteres</li>
              <li><strong>Exames:</strong> Pelo menos um exame deve ser selecionado</li>
            </ul>
            
            <div style="background: rgba(0, 191, 255, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
              <strong>üí° Dica CNS:</strong> O sistema prioriza o formato CNS. Digite mais de 11 d√≠gitos para formata√ß√£o autom√°tica como CNS (000 0000 0000 0000).
            </div>
            
            <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">Hist√≥rico Inteligente:</h3>
            <p style="line-height: 1.6;">Ao digitar 3 ou mais d√≠gitos no campo CNS/CPF, o sistema exibe automaticamente um hist√≥rico de pacientes similares. Use as setas ‚Üë‚Üì para navegar e Enter para selecionar.</p>
          </section>
          
          <!-- 3. Busca -->
          <section id="busca" style="margin-bottom: 40px;">
            <h2 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px;">3. üîç Sistema de Busca</h2>
            <p style="margin: 15px 0; line-height: 1.6;">A busca √© realizada em <strong>tempo real</strong> em todos os campos do paciente:</p>
            <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li>Nome completo</li>
              <li>CNS/CPF (com ou sem formata√ß√£o)</li>
              <li>Data de nascimento</li>
              <li>Telefone</li>
              <li>G√™nero</li>
              <li>Laborat√≥rio</li>
              <li>Endere√ßo</li>
              <li>Exames selecionados</li>
              <li>Data de cadastro</li>
            </ul>
            
            <div style="background: rgba(50, 205, 50, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
              <strong>‚ö° Performance:</strong> A busca usa debounce de 300ms e cache para otimizar a performance mesmo com muitos registros.
            </div>
          </section>
          
          <!-- 4. Exames -->
          <section id="exames" style="margin-bottom: 40px;">
            <h2 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px;">4. üß™ Sele√ß√£o de Exames</h2>
            <p style="margin: 15px 0; line-height: 1.6;">O sistema possui um cat√°logo completo de exames organizados por categorias:</p>
            
            <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">Categorias Dispon√≠veis:</h3>
            <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li><strong>Hematologia:</strong> Hemograma, VHS, Grupo sangu√≠neo, etc.</li>
              <li><strong>Bioqu√≠mica:</strong> Glicose, Colesterol, Creatinina, etc.</li>
              <li><strong>Endocrinologia:</strong> TSH, T3, T4, HCG, etc.</li>
              <li><strong>Sorologia:</strong> HIV, Hepatites, Toxoplasmose, etc.</li>
              <li><strong>Urina e Fezes:</strong> EAS, Urocultura, Parasitol√≥gico, etc.</li>
              <li><strong>Coagula√ß√£o:</strong> TP, TTPA, etc.</li>
            </ul>
            
            <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">Como Selecionar:</h3>
            <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li>Clique em "Selecionar Exames"</li>
              <li>Navegue pelas categorias organizadas em colunas</li>
              <li>Clique nos exames desejados (ficar√£o destacados em verde)</li>
              <li>Confirme a sele√ß√£o</li>
            </ol>
          </section>
          
          <!-- 5. Edi√ß√£o -->
          <section id="edicao" style="margin-bottom: 40px;">
            <h2 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px;">5. ‚úèÔ∏è Edi√ß√£o e Exclus√£o</h2>
            
            <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">Editando Pacientes:</h3>
            <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li>Clique no bot√£o ‚úèÔ∏è na linha do paciente</li>
              <li>Os dados ser√£o carregados no formul√°rio principal</li>
              <li>Fa√ßa as altera√ß√µes necess√°rias</li>
              <li>Clique em "Salvar" ou use Ctrl+S</li>
            </ol>
            
            <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">Exclus√£o Segura:</h3>
            <p style="line-height: 1.6;">O sistema possui <strong>tripla confirma√ß√£o</strong> para exclus√µes:</p>
            <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li>Primeira confirma√ß√£o com dados do paciente</li>
              <li>Digita√ß√£o do nome completo para confirmar</li>
              <li>Confirma√ß√£o final antes da exclus√£o</li>
            </ol>
            
            <div style="background: rgba(220, 53, 69, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
              <strong>‚ö†Ô∏è Aten√ß√£o:</strong> A exclus√£o √© permanente e n√£o pode ser desfeita. Mantenha backups regulares.
            </div>
          </section>
          
          <!-- 6. Dashboard -->
          <section id="dashboard" style="margin-bottom: 40px;">
            <h2 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px;">6. üìä Dashboard e Estat√≠sticas</h2>
            <p style="margin: 15px 0; line-height: 1.6;">O dashboard oferece an√°lises completas dos dados cadastrados:</p>
            
            <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">M√©tricas Principais:</h3>
            <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li><strong>Total de Pacientes:</strong> Contador geral com percentual de crescimento</li>
              <li><strong>Cadastros Hoje:</strong> Registros do dia atual</li>
              <li><strong>Cadastros do M√™s:</strong> Com m√©dia di√°ria</li>
              <li><strong>Taxa de Contato:</strong> Percentual de pacientes com telefone</li>
              <li><strong>Valores Financeiros:</strong> Gastos totais e m√©dia por paciente</li>
            </ul>
            
            <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">An√°lises Dispon√≠veis:</h3>
            <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li>Distribui√ß√£o por g√™nero e faixa et√°ria</li>
              <li>Gastos por laborat√≥rio e categoria</li>
              <li>Top 15 exames mais solicitados</li>
              <li>Pacientes mais recorrentes</li>
              <li>Cadastros mensais (gr√°fico)</li>
              <li>Qualidade dos dados de contato</li>
            </ul>
            
            <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
              <strong>üìÖ Filtros:</strong> Use o seletor de m√™s para analisar per√≠odos espec√≠ficos. O dashboard pode ser impresso para relat√≥rios.
            </div>
          </section>
          
          <!-- 7. Backup -->
          <section id="backup" style="margin-bottom: 40px;">
            <h2 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px;">7. üíæ Backup e Importa√ß√£o</h2>
            
            <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">Backup Autom√°tico:</h3>
            <p style="line-height: 1.6;">O sistema cria backups automaticamente:</p>
            <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li>A cada cadastro, edi√ß√£o ou exclus√£o</li>
              <li>Arquivo Excel com timestamp</li>
              <li>Dados ordenados por data (mais recentes primeiro)</li>
              <li>Lembrete di√°rio para backup manual</li>
            </ul>
            
            <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">Exporta√ß√£o Manual:</h3>
            <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li>Clique em "Exportar Excel" ou use Ctrl+E</li>
              <li>Arquivo ser√° baixado com nome: SCEL_dados_AAAA-MM-DD_HHhMM.xlsx</li>
              <li>Cont√©m todos os dados formatados para planilha</li>
            </ol>
            
            <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">Importa√ß√£o:</h3>
            <div style="background: rgba(220, 53, 69, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
              <strong>‚ö†Ô∏è CUIDADO:</strong> A importa√ß√£o substitui TODOS os dados existentes. √â uma a√ß√£o irrevers√≠vel com tripla confirma√ß√£o.
            </div>
            <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
              <li>Clique em "Importar Excel"</li>
              <li>Selecione arquivo .xlsx ou .xls</li>
              <li>Confirme as tr√™s etapas de seguran√ßa</li>
              <li>Aguarde o processamento</li>
            </ol>
          </section>
          
          <!-- 8. Atalhos -->
          <section id="atalhos" style="margin-bottom: 40px;">
            <h2 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px;">8. ‚å®Ô∏è Atalhos de Teclado</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div>
                <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">A√ß√µes Principais:</h3>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8; font-family: monospace;">
                  <li><strong>Ctrl + S</strong> - Salvar/Cadastrar</li>
                  <li><strong>Ctrl + E</strong> - Exportar Excel</li>
                  <li><strong>Ctrl + D</strong> - Abrir Dashboard</li>
                  <li><strong>F3</strong> - Focar na busca</li>
                  <li><strong>ESC</strong> - Fechar modais</li>
                </ul>
              </div>
              
              <div>
                <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">Navega√ß√£o:</h3>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8; font-family: monospace;">
                  <li><strong>‚Üë ‚Üì</strong> - Navegar hist√≥rico CNS</li>
                  <li><strong>Enter</strong> - Selecionar do hist√≥rico</li>
                  <li><strong>Tab</strong> - Navegar entre campos</li>
                  <li><strong>Shift + Tab</strong> - Voltar campo anterior</li>
                </ul>
              </div>
            </div>
          </section>
          
          <!-- 9. Dicas -->
          <section id="dicas" style="margin-bottom: 40px;">
            <h2 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px;">9. üí° Dicas Avan√ßadas</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div>
                <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">Performance:</h3>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                  <li>Busca otimizada com cache interno</li>
                  <li>Renderiza√ß√£o eficiente com fragments</li>
                  <li>Debounce em buscas e hist√≥rico</li>
                  <li>Limita√ß√£o de resultados para performance</li>
                </ul>
                
                <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">Seguran√ßa:</h3>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                  <li>Valida√ß√µes m√∫ltiplas nos formul√°rios</li>
                  <li>Confirma√ß√µes triplas para exclus√µes</li>
                  <li>Backup autom√°tico preventivo</li>
                  <li>Armazenamento local seguro</li>
                </ul>
              </div>
              
              <div>
                <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">Produtividade:</h3>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                  <li>Hist√≥rico inteligente de CNS</li>
                  <li>Formata√ß√£o autom√°tica de campos</li>
                  <li>Busca em tempo real</li>
                  <li>Atalhos de teclado completos</li>
                </ul>
                
                <h3 style="color: var(--secondary); margin: 20px 0 10px 0;">Manuten√ß√£o:</h3>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                  <li>Fa√ßa backup semanal dos dados</li>
                  <li>Monitore a qualidade dos contatos</li>
                  <li>Use filtros no dashboard para an√°lises</li>
                  <li>Verifique duplica√ß√µes periodicamente</li>
                </ul>
              </div>
            </div>
            
            <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: #333; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center;">
              <h3 style="margin-bottom: 10px;">üéÜ Parab√©ns!</h3>
              <p style="font-size: 1.1rem; line-height: 1.6;">Voc√™ agora domina todas as funcionalidades do SCEL. Use este manual como refer√™ncia sempre que precisar!</p>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <script>
    let pacientes = JSON.parse(localStorage.getItem('pacientes')) || [];
    let examesSelecionados = [];
    let pacienteEditando = null;

    // Formata√ß√£o de campos e busca autom√°tica por CNS - Otimizada
    let timeoutBusca;
    document.getElementById('cpf').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      
      // Debounce para busca de hist√≥rico
      clearTimeout(timeoutBusca);
      
      if (value.length >= 3) {
        timeoutBusca = setTimeout(() => buscarHistoricoCns(value), 300);
      } else {
        document.getElementById('historicoCns').style.display = 'none';
      }
      
      // Formata√ß√£o priorizando CNS
      if (value.length > 11) {
        // Formato CNS (15 d√≠gitos)
        value = value.replace(/(\d{3})(\d{4})(\d{4})(\d{4})/, '$1 $2 $3 $4');
      } else if (value.length >= 4) {
        // Formato CPF (11 d√≠gitos)
        value = value.replace(/(\d{3})(\d)/, '$1.$2')
                    .replace(/(\d{3})(\d)/, '$1.$2')
                    .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      }
      e.target.value = value;
    });

    document.getElementById('telefone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      value = value.replace(/(\d{2})(\d)/, '($1) $2');
      value = value.replace(/(\d{5})(\d)/, '$1-$2');
      e.target.value = value;
    });

    // Sistema de Toast melhorado
    function showToast(message, type = 'success', duration = 4000) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '‚úì',
        error: '‚ö†',
        warning: '‚ö†',
        info: '‚Ñπ'
      };
      
      const titles = {
        success: 'Sucesso!',
        error: 'Erro!',
        warning: 'Aten√ß√£o!',
        info: 'Informa√ß√£o'
      };
      
      toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 1.2em;">${icons[type]}</span>
          <div>
            <strong>${titles[type]}</strong>
            <div>${message}</div>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.2em; cursor: pointer; margin-left: auto;">√ó</button>
        </div>
      `;
      
      document.getElementById('toastContainer').appendChild(toast);
      
      setTimeout(() => {
        if (toast.parentElement) {
          toast.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => toast.remove(), 300);
        }
      }, duration);
    }
    
    // Adicionar anima√ß√£o de sa√≠da
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideOut {
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
    
    // Buscar hist√≥rico por CNS - Otimizada
    function buscarHistoricoCns(termo) {
      const historicoDiv = document.getElementById('historicoCns');
      if (!historicoDiv || !termo || termo.length < 3) {
        if (historicoDiv) historicoDiv.style.display = 'none';
        return;
      }
      
      const termoBusca = termo.replace(/\D/g, '');
      
      // Busca otimizada com limite de resultados
      const historico = pacientes
        .filter(p => p.cpf && String(p.cpf).replace(/\D/g, '').includes(termoBusca) && 
                     String(p.cpf).replace(/\D/g, '') !== termoBusca)
        .slice(0, 10); // Limitar a 10 resultados
      
      if (historico.length === 0) {
        historicoDiv.style.display = 'none';
        return;
      }
      
      // Fragment para melhor performance
      const fragment = document.createDocumentFragment();
      historico.forEach(p => {
        const div = document.createElement('div');
        div.className = 'historico-item';
        div.onclick = () => preencherDadosCns(p.id);
        div.innerHTML = `
          <div class="historico-nome">${p.nome}</div>
          <div class="historico-detalhes">
            CNS/CPF: ${p.cpf} | √öltimo cadastro: ${p.dataCadastro}
          </div>
        `;
        fragment.appendChild(div);
      });
      
      historicoDiv.innerHTML = '';
      historicoDiv.appendChild(fragment);
      historicoDiv.style.display = 'block';
    }
    
    // Preencher dados do paciente selecionado
    function preencherDadosCns(pacienteId) {
      const paciente = pacientes.find(p => p.id == pacienteId);
      if (!paciente) {
        console.log('Paciente n√£o encontrado:', pacienteId);
        return;
      }
      
      document.getElementById('nome').value = paciente.nome || '';
      document.getElementById('cpf').value = paciente.cpf || '';
      document.getElementById('dataNascimento').value = paciente.dataNascimento || '';
      document.getElementById('telefone').value = paciente.telefone || '';
      document.getElementById('laboratorio').value = paciente.laboratorio || '';
      document.getElementById('endereco').value = paciente.endereco || '';
      
      // Configurar g√™nero
      if (paciente.genero === 'masculino' || paciente.genero === 'feminino') {
        document.getElementById('genero').value = paciente.genero;
        document.getElementById('outroGeneroDiv').style.display = 'none';
      } else if (paciente.genero) {
        document.getElementById('genero').value = 'outro';
        document.getElementById('outroGenero').value = paciente.genero;
        document.getElementById('outroGeneroDiv').style.display = 'block';
      }
      
      // Configurar exames se existirem
      if (paciente.exames && Array.isArray(paciente.exames)) {
        examesSelecionados = [...paciente.exames];
        atualizarExamesVisualizacao();
      }
      
      document.getElementById('historicoCns').style.display = 'none';
      showToast('Dados preenchidos automaticamente', 'info');
    }

    // Lista de exames atualizada
    const examesDisponiveis = {
      'Hematologia': [
        { codigo: 'ABO', nome: 'DETERMINA√á√ÉO DO GRUPO SANGUINIO', valor: 1.37 },
        { codigo: 'COMBI', nome: 'COOMBS INDIRETO', valor: 2.73 },
        { codigo: 'HEMO', nome: 'HEMOGRAMA COMPLETO', valor: 4.11 },
        { codigo: 'RH', nome: 'DETERMINA√á√ÉO DO FATOR RH', valor: 1.37 },
        { codigo: 'VHS', nome: 'VELOCIDADE DE HEMOSSEDIMENTA√á√ÉO', valor: 2.73 }
      ],
      'Bioqu√≠mica': [
        { codigo: 'ACUR', nome: 'ACIDO URICO', valor: 1.85 },
        { codigo: 'BTFA', nome: 'BILIRRUBINAST F', valor: 2.01 },
        { codigo: 'CA', nome: 'CALCIO', valor: 1.85 },
        { codigo: 'COL', nome: 'COLESTEROL TOTAL', valor: 1.85 },
        { codigo: 'CPK', nome: 'CREATINO FOSFOQUINASE (C.P.K.)', valor: 3.68 },
        { codigo: 'CR', nome: 'CREATININA', valor: 1.85 },
        { codigo: 'FAL', nome: 'FOSFATASE ALCALINA', valor: 2.01 },
        { codigo: 'FERRO', nome: 'FERRO SERICO', valor: 3.51 },
        { codigo: 'GGT', nome: 'GAMA GLUTAMINA TRANSFERASE', valor: 3.51 },
        { codigo: 'GLI', nome: 'GLICOSE', valor: 1.85 },
        { codigo: 'GLICO', nome: 'GLICEMIA POS-PRANDIAL', valor: 1.85 },
        { codigo: 'HBGLA', nome: 'HEMOGLOBINA GLICADA (GLICEMIA MEDIA)', valor: 7.86 },
        { codigo: 'HDL', nome: 'HDL-COLESTEROL', valor: 3.51 },
        { codigo: 'IST', nome: 'IST-INDICE DE SATURA√á√ÉO DE TRANSFERRINA', valor: 4.12 },
        { codigo: 'K', nome: 'POTASSIO', valor: 1.85 },
        { codigo: 'LDL', nome: 'LDL-COLESTEROL', valor: 3.51 },
        { codigo: 'NA', nome: 'SODIO', valor: 1.85 },
        { codigo: 'PCR', nome: 'PROTEINA C REATIVA', valor: 2.83 },
        { codigo: 'PTFA', nome: 'PROTEINAS TOTAIS E FRA√áOES', valor: 1.85 },
        { codigo: 'TGO', nome: 'TRANSAMINASE GLUTAMICA OXALACETICA', valor: 2.01 },
        { codigo: 'TGP', nome: 'TRANSAMINASE GLUTAMICA PIRUVICA', valor: 2.01 },
        { codigo: 'TRI', nome: 'TRIGLICERIDES', valor: 3.51 },
        { codigo: 'UREIA', nome: 'UREIA', valor: 1.85 },
        { codigo: 'VLDL', nome: 'VLDL-COLESTEROL', valor: 1.85 }
      ],
      'Endocrinologia': [
        { codigo: 'HCG', nome: 'TESTE DE GRAVIDES', valor: 7.85 },
        { codigo: 'T3A', nome: 'TRIODOTIRONINA-T3 LIVRE', valor: 8.71 },
        { codigo: 'T4LA', nome: 'TIROXINA LIVRE-T4L', valor: 11.6 },
        { codigo: 'TSH', nome: 'HORMONIO TIREOESTIMULANTE', valor: 8.96 }
      ],
      'Sorologia': [
        { codigo: 'ASLO', nome: 'ANTIESTREPTOLISINA-O', valor: 2.83 },
        { codigo: 'CITMG', nome: 'CITOMEGALOVIRUS- ANTICORPOS IGG', valor: 11 },
        { codigo: 'CITMM', nome: 'CITOMEGALOVIRUS- ANTICORPOS IGM', valor: 11.61 },
        { codigo: 'HBSAG', nome: 'HEPATITE B- HBSAG', valor: 18.55 },
        { codigo: 'HCVA', nome: 'HEPATITE C- ANTI HCV', valor: 18.55 },
        { codigo: 'HIV', nome: 'HIV-IMUNOENSAIO 4 GERA√áAO', valor: 10 },
        { codigo: 'LATEX', nome: 'FATOR REUMATOIDE', valor: 2.83 },
        { codigo: 'RUBGA', nome: 'RUBEOLA IGG', valor: 17.16 },
        { codigo: 'RUBMA', nome: 'RUBEOLA IGM', valor: 17.16 },
        { codigo: 'TOXOG', nome: 'TOXOPLASMOSE IGG (ECLIA)', valor: 16.97 },
        { codigo: 'TOXOM', nome: 'TOXOPLASMOSE ANTICORPOS IGM (CMIA)', valor: 18.55 },
        { codigo: 'VDRL', nome: 'VDRL-LUES', valor: 2.83 }
      ],
      'Urina e Fezes': [
        { codigo: 'CCCT', nome: 'ANTIBIOGRAMA + MIC', valor: 13.33 },
        { codigo: 'CULT', nome: 'CULTURA UROCULTURA', valor: 5.62 },
        { codigo: 'FESES', nome: 'PARASITOLOGICO (MIF)', valor: 1.65 },
        { codigo: 'PSO', nome: 'SANGUE OCULTO PESQUISA', valor: 1.65 },
        { codigo: 'URINA', nome: 'URINA JATO MEDIO', valor: 3.7 }
      ],
      'Coagula√ß√£o': [
        { codigo: 'TC', nome: 'TEMPO DE COAGULA√á√ÉO', valor: 2.73 },
        { codigo: 'TP', nome: 'TEMPO DE PROTOMBINA', valor: 2.73 }
      ]
    };

    let examesTemporarios = [];

    // Gerenciamento de exames
    function abrirModalExames() {
      examesTemporarios = [...examesSelecionados];
      carregarExamesModal();
      document.getElementById('modalExames').style.display = 'block';
    }

    function fecharModalExames() {
      document.getElementById('modalExames').style.display = 'none';
    }

    function confirmarExames() {
      examesSelecionados = [...examesTemporarios];
      atualizarExamesVisualizacao();
      fecharModalExames();
    }

    function carregarExamesModal() {
      const grid = document.getElementById('examesModalGrid');
      let html = '';
      
      // Criar lista √∫nica de todos os exames
      const todosExames = [];
      Object.keys(examesDisponiveis).forEach(categoria => {
        examesDisponiveis[categoria].forEach(exame => {
          todosExames.push(exame);
        });
      });
      
      // Ordenar alfabeticamente por c√≥digo
      todosExames.sort((a, b) => a.codigo.localeCompare(b.codigo));
      
      // Dividir em quatro colunas
      const quarto = Math.ceil(todosExames.length / 4);
      const coluna1 = todosExames.slice(0, quarto);
      const coluna2 = todosExames.slice(quarto, quarto * 2);
      const coluna3 = todosExames.slice(quarto * 2, quarto * 3);
      const coluna4 = todosExames.slice(quarto * 3);
      
      // Coluna 1
      html += '<div class="coluna-exames">';
      coluna1.forEach(exame => {
        const selecionado = examesTemporarios.find(e => e.valor === exame.codigo || e.texto.includes(exame.codigo)) ? 'selecionado' : '';
        html += `
          <div class="exame-item ${selecionado}" onclick="toggleExameModal('${exame.codigo}', '${exame.nome}')">
            <span class="exame-codigo">${exame.codigo}</span>
            <span class="exame-nome">${exame.nome}</span>
          </div>
        `;
      });
      html += '</div>';
      
      // Coluna 2
      html += '<div class="coluna-exames">';
      coluna2.forEach(exame => {
        const selecionado = examesTemporarios.find(e => e.valor === exame.codigo || e.texto.includes(exame.codigo)) ? 'selecionado' : '';
        html += `
          <div class="exame-item ${selecionado}" onclick="toggleExameModal('${exame.codigo}', '${exame.nome}')">
            <span class="exame-codigo">${exame.codigo}</span>
            <span class="exame-nome">${exame.nome}</span>
          </div>
        `;
      });
      html += '</div>';
      
      // Coluna 3
      html += '<div class="coluna-exames">';
      coluna3.forEach(exame => {
        const selecionado = examesTemporarios.find(e => e.valor === exame.codigo || e.texto.includes(exame.codigo)) ? 'selecionado' : '';
        html += `
          <div class="exame-item ${selecionado}" onclick="toggleExameModal('${exame.codigo}', '${exame.nome}')">
            <span class="exame-codigo">${exame.codigo}</span>
            <span class="exame-nome">${exame.nome}</span>
          </div>
        `;
      });
      html += '</div>';
      
      // Coluna 4
      html += '<div class="coluna-exames">';
      coluna4.forEach(exame => {
        const selecionado = examesTemporarios.find(e => e.valor === exame.codigo || e.texto.includes(exame.codigo)) ? 'selecionado' : '';
        html += `
          <div class="exame-item ${selecionado}" onclick="toggleExameModal('${exame.codigo}', '${exame.nome}')">
            <span class="exame-codigo">${exame.codigo}</span>
            <span class="exame-nome">${exame.nome}</span>
          </div>
        `;
      });
      html += '</div>';
      
      grid.innerHTML = html;
    }



    function toggleExameModal(codigo, nome) {
      const item = event.target.closest('.exame-item');
      const jaExiste = examesTemporarios.find(e => e.valor === codigo);
      
      if (jaExiste) {
        examesTemporarios = examesTemporarios.filter(e => e.valor !== codigo);
        item.classList.remove('selecionado');
      } else {
        examesTemporarios.push({ valor: codigo, texto: `${codigo} - ${nome}` });
        item.classList.add('selecionado');
      }
    }

    function removerExame(valor) {
      examesSelecionados = examesSelecionados.filter(e => e.valor !== valor);
      atualizarExamesVisualizacao();
    }

    function atualizarExamesVisualizacao() {
      const container = document.getElementById('examesSelecionados');
      
      if (examesSelecionados.length === 0) {
        container.innerHTML = '<small style="color: #666;">Nenhum exame selecionado</small>';
        return;
      }
      
      container.innerHTML = examesSelecionados.map(exame => 
        `<span class="exame-tag">${exame.texto} <button type="button" onclick="removerExame('${exame.valor}')" style="background:none;border:none;color:#333;margin-left:5px;cursor:pointer;">√ó</button></span>`
      ).join('');
    }

    // Valida√ß√µes avan√ßadas
    function validarFormulario() {
      const nome = document.getElementById('nome').value.trim();
      const cpf = document.getElementById('cpf').value.trim();
      const dataNasc = document.getElementById('dataNascimento').value;
      const genero = document.getElementById('genero').value;
      const laboratorio = document.getElementById('laboratorio').value;
      const endereco = document.getElementById('endereco').value.trim();
      
      const erros = [];
      
      if (!nome || nome.length < 2) erros.push('Nome deve ter pelo menos 2 caracteres');
      if (!cpf || cpf.replace(/\D/g, '').length < 11) erros.push('CNS/CPF inv√°lido');
      if (!dataNasc) erros.push('Data de nascimento √© obrigat√≥ria');
      if (!genero) erros.push('G√™nero √© obrigat√≥rio');
      if (!laboratorio) erros.push('Laborat√≥rio √© obrigat√≥rio');
      if (!endereco || endereco.length < 10) erros.push('Endere√ßo deve ter pelo menos 10 caracteres');
      if (examesSelecionados.length === 0) erros.push('Selecione pelo menos um exame');
      
      // Validar idade
      if (dataNasc) {
        const idade = new Date().getFullYear() - new Date(dataNasc).getFullYear();
        if (idade < 0 || idade > 120) erros.push('Data de nascimento inv√°lida');
      }
      
      // Avisar sobre duplica√ß√£o de CPF (n√£o impede cadastro)
      if (!pacienteEditando && cpf) {
        const cpfLimpo = cpf.replace(/\D/g, '');
        const duplicado = pacientes.find(p => p.cpf && String(p.cpf).replace(/\D/g, '') === cpfLimpo);
        if (duplicado) {
          showToast('‚ö†Ô∏è J√° existe um paciente com este CNS/CPF. Verifique se n√£o √© duplica√ß√£o.', 'warning', 5000);
        }
      }
      
      return erros;
    }
    
    // Cadastro/Edi√ß√£o de paciente
    document.getElementById('pacienteForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const erros = validarFormulario();
      if (erros.length > 0) {
        showToast(erros.join('<br>'), 'error', 6000);
        return;
      }
      
      if (pacienteEditando) {
        // Modo edi√ß√£o
        pacienteEditando.nome = document.getElementById('nome').value.toUpperCase();
        pacienteEditando.cpf = document.getElementById('cpf').value;
        pacienteEditando.dataNascimento = document.getElementById('dataNascimento').value;
        pacienteEditando.telefone = document.getElementById('telefone').value;
        pacienteEditando.genero = document.getElementById('genero').value === 'outro' ? document.getElementById('outroGenero').value : document.getElementById('genero').value;
        pacienteEditando.laboratorio = document.getElementById('laboratorio').value;
        pacienteEditando.endereco = document.getElementById('endereco').value.toUpperCase();
        pacienteEditando.exames = [...examesSelecionados];
        
        localStorage.setItem('pacientes', JSON.stringify(pacientes));
        criarBackupAutomatico();
        showToast('Paciente atualizado com sucesso');
        
        // Limpar formul√°rio sem mostrar toast
        pacienteEditando = null;
        document.getElementById('pacienteForm').reset();
        examesSelecionados = [];
        atualizarExamesVisualizacao();
        document.getElementById('outroGeneroDiv').style.display = 'none';
        
        // Voltar bot√µes para modo cadastro
        document.getElementById('btnCadastrar').style.display = 'block';
        document.getElementById('botoesEdicao').style.display = 'none';
      } else {
        // Modo cadastro
        const paciente = {
          id: Date.now(),
          nome: document.getElementById('nome').value.toUpperCase(),
          cpf: document.getElementById('cpf').value,
          dataNascimento: document.getElementById('dataNascimento').value,
          telefone: document.getElementById('telefone').value,
          genero: document.getElementById('genero').value === 'outro' ? document.getElementById('outroGenero').value : document.getElementById('genero').value,
          laboratorio: document.getElementById('laboratorio').value,
          endereco: document.getElementById('endereco').value.toUpperCase(),
          exames: [...examesSelecionados],
          dataCadastro: new Date().toLocaleDateString('pt-BR')
        };
        
        pacientes.push(paciente);
        localStorage.setItem('pacientes', JSON.stringify(pacientes));
        criarBackupAutomatico();
        showToast('Paciente cadastrado com sucesso');
        
        document.getElementById('pacienteForm').reset();
        examesSelecionados = [];
        atualizarExamesVisualizacao();
      }
      
      atualizarTabela();
      document.getElementById('nome').focus();
    });



    // Busca otimizada com debounce
    let timeoutBuscaPacientes;
    function buscarPacientes() {
      clearTimeout(timeoutBuscaPacientes);
      timeoutBuscaPacientes = setTimeout(() => {
        const termo = document.getElementById('busca').value.toLowerCase().trim();
        
        if (!termo) {
          atualizarTabela(pacientes);
          return;
        }
        
        const pacientesFiltrados = pacientes.filter(p => {
          try {
            // Cache de valores formatados
            if (!p._searchCache) {
              p._searchCache = {
                dataNasc: p.dataNascimento ? new Date(p.dataNascimento).toLocaleDateString('pt-BR') : '',
                exames: p.exames && Array.isArray(p.exames) ? p.exames.map(e => e.texto || '').join(' ').toLowerCase() : '',
                searchText: [
                  p.nome || '',
                  p.cpf || '',
                  p.telefone || '',
                  p.genero || '',
                  p.laboratorio || '',
                  p.endereco || '',
                  p.dataCadastro || ''
                ].join(' ').toLowerCase()
              };
            }
            
            return p._searchCache.searchText.includes(termo) ||
                   p._searchCache.dataNasc.includes(termo) ||
                   p._searchCache.exames.includes(termo);
          } catch (error) {
            console.error('Erro na busca:', error, p);
            return false;
          }
        });
        
        atualizarTabela(pacientesFiltrados);
      }, 300);
    }

    // Fun√ß√µes de formata√ß√£o
    function formatarGenero(genero) {
      if (!genero) return '-';
      const generos = {
        'masculino': 'Masculino',
        'feminino': 'Feminino'
      };
      return generos[genero] || genero;
    }
    
    function formatarLaboratorio(laboratorio) {
      if (!laboratorio) return '-';
      const laboratorios = {
        'apolo': 'Apolo',
        'queiroz': 'Queiroz',
        'sao_lourenco': 'S√£o Louren√ßo'
      };
      return laboratorios[laboratorio] || laboratorio;
    }

    // Tabela otimizada com pagina√ß√£o virtual
    function atualizarTabela(lista = pacientes) {
      const tbody = document.getElementById('tabelaPacientes');
      
      if (lista.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666; padding: 30px;">Nenhum paciente encontrado</td></tr>';
        return;
      }
      
      // Ordena√ß√£o otimizada
      const listaOrdenada = [...lista].sort((a, b) => {
        // Cache de datas para evitar rec√°lculos
        if (!a._sortDate) a._sortDate = new Date(a.dataCadastro.split('/').reverse().join('-')).getTime();
        if (!b._sortDate) b._sortDate = new Date(b.dataCadastro.split('/').reverse().join('-')).getTime();
        
        return b._sortDate !== a._sortDate ? b._sortDate - a._sortDate : b.id - a.id;
      });
      
      // Renderiza√ß√£o otimizada com fragment
      const fragment = document.createDocumentFragment();
      
      listaOrdenada.forEach(paciente => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${paciente.dataCadastro}</td>
          <td>${paciente.nome}</td>
          <td>${paciente.cpf}</td>
          <td>${new Date(paciente.dataNascimento).toLocaleDateString('pt-BR')}</td>
          <td>${paciente.telefone || '-'}</td>
          <td>${formatarGenero(paciente.genero)}</td>
          <td>${formatarLaboratorio(paciente.laboratorio)}</td>
          <td>${paciente.endereco || '-'}</td>
          <td>${paciente.exames.map(e => e.texto).join(', ')}</td>
          <td class="actions">
            <button class="btn btn-small" onclick="editarPaciente(${paciente.id})">‚úèÔ∏è</button>
            <button class="btn btn-small btn-danger" onclick="excluirPaciente(${paciente.id})">üóëÔ∏è</button>
          </td>
        `;
        fragment.appendChild(tr);
      });
      
      tbody.innerHTML = '';
      tbody.appendChild(fragment);
    }

    // Edi√ß√£o
    function editarPaciente(id) {
      pacienteEditando = pacientes.find(p => p.id === id);
      
      // Copiar dados para o formul√°rio principal
      document.getElementById('nome').value = pacienteEditando.nome;
      document.getElementById('cpf').value = pacienteEditando.cpf;
      document.getElementById('dataNascimento').value = pacienteEditando.dataNascimento;
      document.getElementById('telefone').value = pacienteEditando.telefone || '';
      document.getElementById('laboratorio').value = pacienteEditando.laboratorio;
      document.getElementById('endereco').value = pacienteEditando.endereco;
      
      // Configurar g√™nero
      if (pacienteEditando.genero === 'masculino' || pacienteEditando.genero === 'feminino') {
        document.getElementById('genero').value = pacienteEditando.genero;
      } else {
        document.getElementById('genero').value = 'outro';
        document.getElementById('outroGenero').value = pacienteEditando.genero;
        document.getElementById('outroGeneroDiv').style.display = 'block';
      }
      
      // Configurar exames
      examesSelecionados = [...pacienteEditando.exames];
      atualizarExamesVisualizacao();
      
      // Alterar bot√µes para modo edi√ß√£o
      document.getElementById('btnCadastrar').style.display = 'none';
      document.getElementById('botoesEdicao').style.display = 'flex';
      
      // Focar no campo nome
      document.getElementById('nome').focus();
      
      showToast('Dados carregados para edi√ß√£o', 'info');
    }
    
    function cancelarEdicao() {
      pacienteEditando = null;
      document.getElementById('pacienteForm').reset();
      examesSelecionados = [];
      atualizarExamesVisualizacao();
      document.getElementById('outroGeneroDiv').style.display = 'none';
      
      // Voltar bot√µes para modo cadastro
      document.getElementById('btnCadastrar').style.display = 'block';
      document.getElementById('botoesEdicao').style.display = 'none';
      
      document.getElementById('nome').focus();
      showToast('Edi√ß√£o cancelada', 'info');
    }

    document.getElementById('formEdicao').addEventListener('submit', function(e) {
      e.preventDefault();
      
      pacienteEditando.nome = document.getElementById('editNome').value.toUpperCase();
      pacienteEditando.telefone = document.getElementById('editTelefone').value;
      pacienteEditando.genero = document.getElementById('editGenero').value === 'outro' ? document.getElementById('editOutroGenero').value : document.getElementById('editGenero').value;
      
      localStorage.setItem('pacientes', JSON.stringify(pacientes));
      showToast('Paciente atualizado com sucesso');
      fecharModal();
      atualizarTabela();
      document.getElementById('nome').focus();
    });

    function fecharModal() {
      document.getElementById('modalEdicao').style.display = 'none';
      pacienteEditando = null;
    }

    // Exclus√£o com prote√ß√£o
    function excluirPaciente(id) {
      const paciente = pacientes.find(p => p.id === id);
      if (!paciente) return;
      
      // Primeira confirma√ß√£o
      if (!confirm(`Tem certeza que deseja excluir o paciente:\n\n${paciente.nome}\nCNS/CPF: ${paciente.cpf}\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
        return;
      }
      
      // Segunda confirma√ß√£o com digita√ß√£o do nome
      const nomeDigitado = prompt(`Para confirmar a exclus√£o, digite o nome completo do paciente:\n\n"${paciente.nome}"`);
      
      if (!nomeDigitado) {
        showToast('Exclus√£o cancelada', 'info');
        return;
      }
      
      if (nomeDigitado.trim().toLowerCase() !== paciente.nome.toLowerCase()) {
        showToast('Nome n√£o confere. Exclus√£o cancelada por seguran√ßa.', 'warning');
        return;
      }
      
      // Terceira confirma√ß√£o final
      if (!confirm('√öLTIMA CONFIRMA√á√ÉO:\n\nVoc√™ tem ABSOLUTA CERTEZA que deseja excluir este paciente?\n\nTodos os dados ser√£o perdidos permanentemente!')) {
        showToast('Exclus√£o cancelada', 'info');
        return;
      }
      
      // Executar exclus√£o
      pacientes = pacientes.filter(p => p.id !== id);
      localStorage.setItem('pacientes', JSON.stringify(pacientes));
      criarBackupAutomatico();
      showToast('Paciente exclu√≠do com sucesso', 'success');
      atualizarTabela();
    }

    // Inicializa√ß√£o otimizada
    window.addEventListener('load', function() {
      // Verificar compatibilidade do navegador
      if (!window.localStorage) {
        showToast('Seu navegador n√£o suporta armazenamento local. Os dados n√£o ser√£o salvos.', 'warning', 8000);
      }
      
      // Carregar dados com loading
      document.body.classList.add('loading');
      
      setTimeout(() => {
        atualizarTabela();
        document.body.classList.remove('loading');
        showToast(`Sistema carregado! ${pacientes.length} pacientes encontrados.`, 'info');
        document.getElementById('nome').focus();
        
        // Verificar se h√° dados para backup
        if (pacientes.length > 0) {
          const ultimoBackup = localStorage.getItem('ultimoBackup');
          const agora = new Date().getTime();
          const umDia = 24 * 60 * 60 * 1000;
          
          if (!ultimoBackup || (agora - parseInt(ultimoBackup)) > umDia) {
            showToast('Recomendamos fazer backup dos dados (bot√£o Exportar Excel)', 'info', 6000);
          }
        }
      }, 100);
    });
    
    // Salvar timestamp do √∫ltimo backup
    function atualizarTimestampBackup() {
      localStorage.setItem('ultimoBackup', new Date().getTime().toString());
    }

    // Fun√ß√µes para mostrar/ocultar campo "outro g√™nero"
    function toggleOutroGenero() {
      const genero = document.getElementById('genero').value;
      const div = document.getElementById('outroGeneroDiv');
      div.style.display = genero === 'outro' ? 'block' : 'none';
      if (genero !== 'outro') {
        document.getElementById('outroGenero').value = '';
      }
    }

    function toggleEditOutroGenero() {
      const genero = document.getElementById('editGenero').value;
      const div = document.getElementById('editOutroGeneroDiv');
      div.style.display = genero === 'outro' ? 'block' : 'none';
      if (genero !== 'outro') {
        document.getElementById('editOutroGenero').value = '';
      }
    }

    // Fun√ß√µes de Backup
    function criarBackupAutomatico() {
      if (pacientes.length === 0) return;
      
      // Ordenar do mais novo para o mais antigo (mesma ordem da tabela)
      const pacientesOrdenados = [...pacientes].sort((a, b) => {
        const dataA = new Date(a.dataCadastro.split('/').reverse().join('-'));
        const dataB = new Date(b.dataCadastro.split('/').reverse().join('-'));
        if (dataB.getTime() !== dataA.getTime()) {
          return dataB.getTime() - dataA.getTime();
        }
        return b.id - a.id;
      });
      
      const dadosExcel = pacientesOrdenados.map(p => ({
        'Data Cadastro': p.dataCadastro,
        'Nome': p.nome,
        'CNS/CPF': p.cpf,
        'Data Nascimento': new Date(p.dataNascimento).toLocaleDateString('pt-BR'),
        'Telefone': p.telefone || '',
        'G√™nero': formatarGenero(p.genero),
        'Laborat√≥rio': formatarLaboratorio(p.laboratorio),
        'Endere√ßo': p.endereco || '',
        'Exames': p.exames.map(e => e.texto).join(', ')
      }));
      
      const ws = XLSX.utils.json_to_sheet(dadosExcel);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Pacientes');
      
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([wbout], {type: 'application/octet-stream'});
      
      const agora = new Date();
      const dataHora = `${agora.toISOString().split('T')[0]}_${agora.getHours().toString().padStart(2, '0')}h${agora.getMinutes().toString().padStart(2, '0')}`;
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `SCEL_backup_${dataHora}.xlsx`;
      link.click();
    }
    
    function exportarExcel() {
      if (pacientes.length === 0) {
        showToast('Nenhum dado para exportar', 'warning');
        return;
      }
      
      // Mostrar loading
      const btnExportar = event.target;
      const textoOriginal = btnExportar.textContent;
      btnExportar.textContent = '‚è≥ Exportando...';
      btnExportar.disabled = true;
      
      // Ordenar do mais novo para o mais antigo (mesma ordem da tabela)
      const pacientesOrdenados = [...pacientes].sort((a, b) => {
        const dataA = new Date(a.dataCadastro.split('/').reverse().join('-'));
        const dataB = new Date(b.dataCadastro.split('/').reverse().join('-'));
        if (dataB.getTime() !== dataA.getTime()) {
          return dataB.getTime() - dataA.getTime();
        }
        return b.id - a.id;
      });
      
      const dadosExcel = pacientesOrdenados.map(p => ({
        'Data Cadastro': p.dataCadastro,
        'Nome': p.nome,
        'CNS/CPF': p.cpf,
        'Data Nascimento': new Date(p.dataNascimento).toLocaleDateString('pt-BR'),
        'Telefone': p.telefone || '',
        'G√™nero': formatarGenero(p.genero),
        'Laborat√≥rio': formatarLaboratorio(p.laboratorio),
        'Endere√ßo': p.endereco || '',
        'Exames': p.exames.map(e => e.texto).join(', ')
      }));
      
      const ws = XLSX.utils.json_to_sheet(dadosExcel);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Pacientes');
      
      const agora = new Date();
      const dataHora = `${agora.toISOString().split('T')[0]}_${agora.getHours().toString().padStart(2, '0')}h${agora.getMinutes().toString().padStart(2, '0')}`;
      
      XLSX.writeFile(wb, `SCEL_dados_${dataHora}.xlsx`);
      atualizarTimestampBackup();
      showToast(`${pacientes.length} pacientes exportados para Excel`, 'success');
      
      // Restaurar bot√£o
      btnExportar.textContent = textoOriginal;
      btnExportar.disabled = false;
    }
    
    function formatarCNS(cns) {
      if (!cns) return '';
      const numeros = cns.toString().replace(/\D/g, '');
      if (numeros.length === 15) {
        return numeros.replace(/(\d{3})(\d{4})(\d{4})(\d{4})/, '$1 $2 $3 $4');
      }
      return cns;
    }
    
    function processarExames(examesTexto) {
      if (!examesTexto) return [];
      
      return examesTexto.split(',').map(exame => {
        const exameTexto = exame.trim();
        // Gerar c√≥digo baseado no texto do exame
        const codigo = exameTexto.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 10) || 'CUSTOM';
        return {
          valor: codigo,
          texto: exameTexto
        };
      }).filter(e => e.texto);
    }
    
    function importarExcel(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          if (jsonData.length > 0) {
            // Primeira confirma√ß√£o
            if (!confirm(`ATEN√á√ÉO: Importa√ß√£o de ${jsonData.length} registros\n\nIsso ir√° SUBSTITUIR TODOS os ${pacientes.length} pacientes atuais!\n\nTodos os dados ser√£o perdidos permanentemente.\n\nDeseja continuar?`)) {
              showToast('Importa√ß√£o cancelada', 'info');
              return;
            }
            
            // Segunda confirma√ß√£o com digita√ß√£o
            const confirmacao = prompt(`Para confirmar a importa√ß√£o, digite:\n\n"CONFIRMAR IMPORTACAO"\n\n(${jsonData.length} novos registros substituir√£o ${pacientes.length} existentes)`);
            
            if (!confirmacao) {
              showToast('Importa√ß√£o cancelada', 'info');
              return;
            }
            
            if (confirmacao.trim().toUpperCase() !== 'CONFIRMAR IMPORTACAO') {
              showToast('Texto de confirma√ß√£o incorreto. Importa√ß√£o cancelada por seguran√ßa.', 'warning');
              return;
            }
            
            // Terceira confirma√ß√£o final
            if (!confirm('√öLTIMA CONFIRMA√á√ÉO:\n\nVoc√™ tem ABSOLUTA CERTEZA que deseja importar os dados?\n\nEsta a√ß√£o √© IRREVERS√çVEL!')) {
              showToast('Importa√ß√£o cancelada', 'info');
              return;
            }
            const pacientesImportados = jsonData.map((row, index) => {
              // Processar data de nascimento
              let dataNasc = '';
              if (row['Data Nascimento']) {
                const data = row['Data Nascimento'];
                if (typeof data === 'number') {
                  // Excel armazena datas como n√∫meros seriais
                  const excelDate = new Date((data - 25569) * 86400 * 1000);
                  dataNasc = excelDate.toISOString().split('T')[0];
                } else if (typeof data === 'string' && data.includes('/')) {
                  const partes = data.split('/');
                  if (partes.length === 3) {
                    dataNasc = `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
                  }
                } else if (data instanceof Date) {
                  dataNasc = data.toISOString().split('T')[0];
                }
              }
              
              // Processar data de cadastro
              let dataCad = new Date().toLocaleDateString('pt-BR');
              if (row['Data Cadastro']) {
                const data = row['Data Cadastro'];
                if (typeof data === 'number') {
                  // Excel armazena datas como n√∫meros seriais
                  const excelDate = new Date((data - 25569) * 86400 * 1000);
                  dataCad = excelDate.toLocaleDateString('pt-BR');
                } else if (typeof data === 'string') {
                  dataCad = data;
                }
              }
              
              return {
                id: Date.now() + index,
                nome: (row['Nome'] || '').toUpperCase(),
                cpf: formatarCNS(row['CNS/CPF']) || '',
                dataNascimento: dataNasc,
                telefone: row['Telefone'] || '',
                genero: row['G√™nero'] === 'Masculino' ? 'masculino' : row['G√™nero'] === 'Feminino' ? 'feminino' : row['G√™nero'] || '',
                laboratorio: row['Laborat√≥rio'] === 'Apolo' ? 'apolo' : row['Laborat√≥rio'] === 'Queiroz' ? 'queiroz' : row['Laborat√≥rio'] === 'S√£o Louren√ßo' ? 'sao_lourenco' : row['Laborat√≥rio'] || '',
                endereco: (row['Endere√ßo'] || '').toUpperCase(),
                exames: processarExames(row['Exames']),
                dataCadastro: dataCad
              };
            });
            
            pacientes = pacientesImportados;
            localStorage.setItem('pacientes', JSON.stringify(pacientes));
            atualizarTabela();
            showToast(`${pacientesImportados.length} pacientes importados do Excel`, 'success');
          }
        } catch (error) {
          console.error('Erro na importa√ß√£o:', error);
          showToast('Erro ao ler arquivo Excel. Verifique o formato.', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
      
      event.target.value = '';
    }

    // Fun√ß√µes do Dashboard
    function abrirEstatisticas() {
      if (pacientes.length === 0) {
        showToast('Nenhum dado para gerar estat√≠sticas', 'warning');
        return;
      }
      
      // Carregar op√ß√µes de m√™s
      carregarMesesDisponiveis();
      
      const stats = calcularEstatisticas();
      const content = document.getElementById('estatisticasContent');
      
      document.getElementById('modalEstatisticas').style.display = 'block';
      atualizarDashboard();
    }
    
    function carregarMesesDisponiveis() {
      const select = document.getElementById('mesFiltro');
      const mesesSet = new Set();
      
      pacientes.forEach(p => {
        if (p.dataCadastro) {
          const partes = p.dataCadastro.split('/');
          if (partes.length === 3) {
            const mes = parseInt(partes[1]);
            const ano = parseInt(partes[2]);
            mesesSet.add(`${ano}-${mes.toString().padStart(2, '0')}`);
          }
        }
      });
      
      const mesesArray = Array.from(mesesSet).sort().reverse();
      const mesesNomes = ['', 'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      
      select.innerHTML = '<option value="todos">Todos os Meses</option>';
      mesesArray.forEach(mesAno => {
        const [ano, mes] = mesAno.split('-');
        const mesNum = parseInt(mes);
        select.innerHTML += `<option value="${mesAno}">${mesesNomes[mesNum]} ${ano}</option>`;
      });
    }
    
    function atualizarDashboard() {
      const mesSelecionado = document.getElementById('mesFiltro').value;
      const stats = calcularEstatisticas(mesSelecionado);
      const content = document.getElementById('estatisticasContent');
      
      content.innerHTML = `
        <style>
          @keyframes countUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
          @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
          @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
          @keyframes glow { 0%, 100% { box-shadow: 0 0 5px rgba(138, 43, 226, 0.5); } 50% { box-shadow: 0 0 20px rgba(138, 43, 226, 0.8); } }
          .metric-card { animation: countUp 0.6s ease-out; transition: all 0.3s ease; }
          .metric-card:hover { transform: translateY(-5px) scale(1.02); animation: glow 2s infinite; }
          .chart-section { animation: slideIn 0.8s ease-out; background: rgba(255,255,255,0.05) !important; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
          .progress-bar { animation: slideIn 1s ease-out; }
          .dark-card { background: rgba(255,255,255,0.08); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2); }
        </style>
        
        <!-- Cards de M√©tricas Principais -->
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px;">
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #8a2be2 0%, #4b0082 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(138, 43, 226, 0.4); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 10px; left: 15px; font-size: 1.5rem; opacity: 0.7;">üë•</div>
            <div style="font-size: 3rem; font-weight: bold; margin-bottom: 8px; text-shadow: 0 0 10px rgba(255,255,255,0.3);">${stats.total}</div>
            <div style="font-size: 0.9rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">TOTAL PACIENTES</div>
            <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 8px;">${stats.crescimento > 0 ? '+' + stats.crescimento.toFixed(1) + '% vs anterior' : 'Base inicial'}</div>
          </div>
          
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #00bfff 0%, #0080ff 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0, 191, 255, 0.4); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 10px; left: 15px; font-size: 1.5rem; opacity: 0.7;">üìÖ</div>
            <div style="font-size: 3rem; font-weight: bold; margin-bottom: 8px; text-shadow: 0 0 10px rgba(255,255,255,0.3);">${stats.hoje}</div>
            <div style="font-size: 0.9rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">HOJE</div>
            <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 8px;">Meta: ${Math.ceil(stats.esteMes / new Date().getDate())}/dia</div>
          </div>
          
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #ff1493 0%, #ff69b4 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(255, 20, 147, 0.4); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 10px; left: 15px; font-size: 1.5rem; opacity: 0.7;">üìà</div>
            <div style="font-size: 3rem; font-weight: bold; margin-bottom: 8px; text-shadow: 0 0 10px rgba(255,255,255,0.3);">${stats.esteMes}</div>
            <div style="font-size: 0.9rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">ESTE M√äS</div>
            <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 8px;">M√©dia: ${(stats.esteMes / new Date().getDate()).toFixed(1)}/dia</div>
          </div>
          
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #32cd32 0%, #00ff7f 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(50, 205, 50, 0.4); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 10px; left: 15px; font-size: 1.5rem; opacity: 0.7;">üìû</div>
            <div style="font-size: 3rem; font-weight: bold; margin-bottom: 8px; text-shadow: 0 0 10px rgba(255,255,255,0.3);">${stats.contatos.percentual}%</div>
            <div style="font-size: 0.9rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">CONTATOS</div>
            <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 8px;">${stats.contatos.percentual >= 80 ? '‚úÖ Excelente' : stats.contatos.percentual >= 60 ? '‚ö†Ô∏è Bom' : '‚ùå Melhorar'}</div>
          </div>
          
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%); color: #333; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4); position: relative; overflow: hidden;">
            <div style="position: absolute; top: 10px; left: 15px; font-size: 1.5rem; opacity: 0.7;">üí∞</div>
            <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 8px; text-shadow: 0 0 10px rgba(0,0,0,0.3);">R$ ${stats.financeiro.valorTotal.toFixed(2)}</div>
            <div style="font-size: 0.9rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">GASTOS TOTAIS</div>
            <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 8px;">M√©dia: R$ ${stats.financeiro.valorMedioPaciente.toFixed(2)}/pac</div>
          </div>
        </div>
        
        <!-- M√©tricas Financeiras -->
        <div style="display: grid; grid-template-columns: repeat(${stats.financeiro.gastosMensal !== null ? '4' : '3'}, 1fr); gap: 15px; margin-bottom: 20px;">
          ${stats.financeiro.gastosMensal !== null ? `
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #20b2aa 0%, #008b8b 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.8rem; font-weight: bold; margin-bottom: 5px;">R$ ${stats.financeiro.gastosMensal.toFixed(2)}</div>
            <div style="font-size: 0.8rem; opacity: 0.9; text-transform: uppercase;">GASTOS MENSAIS</div>
          </div>` : ''}
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #dc143c 0%, #b22222 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px;">R$ ${stats.financeiro.exameMaisCaro.valor.toFixed(2)}</div>
            <div style="font-size: 0.7rem; opacity: 0.9; text-transform: uppercase;">EXAME MAIS CARO</div>
            <div style="font-size: 0.6rem; opacity: 0.7; margin-top: 3px;">${stats.financeiro.exameMaisCaro.nome.substring(0, 20)}...</div>
          </div>
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #228b22 0%, #006400 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px;">R$ ${stats.financeiro.exameMaisBarato.valor.toFixed(2)}</div>
            <div style="font-size: 0.7rem; opacity: 0.9; text-transform: uppercase;">EXAME MAIS BARATO</div>
            <div style="font-size: 0.6rem; opacity: 0.7; margin-top: 3px;">${stats.financeiro.exameMaisBarato.nome.substring(0, 20)}...</div>
          </div>
          <div class="metric-card dark-card" style="background: linear-gradient(135deg, #9370db 0%, #663399 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 5px;">R$ ${stats.financeiro.valorMedioPaciente.toFixed(2)}</div>
            <div style="font-size: 0.7rem; opacity: 0.9; text-transform: uppercase;">VALOR M√âDIO/PACIENTE</div>
          </div>
        </div>
        
        <!-- Gr√°fico Principal - Cadastros Mensais -->
        <div class="chart-section dark-card" style="margin-bottom: 20px; padding: 20px; border-radius: 15px;">
          <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 1rem;">üìà CADASTROS MENSAIS</h3>
          <div style="display: flex; align-items: end; justify-content: space-between; height: 80px; margin-bottom: 10px; padding: 0 5px; overflow: hidden;">
            ${stats.cadastrosMensais.map((mes, i) => {
              const maxCount = Math.max(...stats.cadastrosMensais.map(m => m.count));
              const altura = maxCount > 0 ? Math.max((mes.count / maxCount) * 60, 4) : 4;
              return `
              <div style="display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 0;">
                <div style="color: #00bfff; font-size: 0.7rem; font-weight: bold; margin-bottom: 3px;">${mes.count}</div>
                <div style="background: linear-gradient(to top, #00bfff, #8a2be2); width: 16px; border-radius: 8px 8px 0 0; height: ${altura}px; animation: slideIn ${0.3 + i * 0.05}s ease-out;"></div>
                <div style="font-size: 0.6rem; color: rgba(255,255,255,0.7); margin-top: 5px; text-transform: uppercase;">${mes.mes}</div>
              </div>
            `}).join('')}
          </div>
        </div>
        
        <!-- Se√ß√£o Principal de An√°lises -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
          <!-- Coluna Esquerda - Gr√°ficos Principais -->
          <div style="display: grid; grid-template-rows: 1fr 1fr; gap: 20px;">
            <!-- Distribui√ß√£o por G√™nero e Laborat√≥rios -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <!-- G√™nero -->
              <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px;">
                <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
                  üë• DISTRIBUI√á√ÉO G√äNERO
                </h3>
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                  <div style="width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(#8a2be2 0deg ${stats.genero.masculinoPerc * 3.6}deg, #ff1493 ${stats.genero.masculinoPerc * 3.6}deg ${(stats.genero.masculinoPerc + stats.genero.femininoPerc) * 3.6}deg, #32cd32 ${(stats.genero.masculinoPerc + stats.genero.femininoPerc) * 3.6}deg 360deg); position: relative; box-shadow: 0 0 15px rgba(138, 43, 226, 0.4);">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; background: rgba(0,0,0,0.8); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; color: white;">${stats.total}</div>
                  </div>
                </div>
                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.9);">
                  <div style="display: flex; align-items: center; margin-bottom: 4px;"><div style="width: 8px; height: 8px; background: #8a2be2; border-radius: 50%; margin-right: 6px;"></div>Masculino: ${stats.genero.masculino}</div>
                  <div style="display: flex; align-items: center; margin-bottom: 4px;"><div style="width: 8px; height: 8px; background: #ff1493; border-radius: 50%; margin-right: 6px;"></div>Feminino: ${stats.genero.feminino}</div>
                  ${stats.genero.outros > 0 ? `<div style="display: flex; align-items: center;"><div style="width: 8px; height: 8px; background: #32cd32; border-radius: 50%; margin-right: 6px;"></div>Outros: ${stats.genero.outros}</div>` : ''}
                </div>
              </div>
          
              <!-- Laborat√≥rios - Financeiro -->
              <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px;">
                <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
                  üè• GASTOS POR LABORAT√ìRIO
                </h3>
                <div style="margin-bottom: 10px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span style="font-size: 0.75rem; color: rgba(255,255,255,0.9);">Apolo</span><span style="font-weight: bold; color: #8a2be2; font-size: 0.8rem;">R$ ${stats.financeiro.laboratorioValores.apolo.toFixed(2)}</span>
                  </div>
                  <div style="background: rgba(255,255,255,0.1); border-radius: 8px; height: 6px; overflow: hidden;">
                    <div class="progress-bar" style="background: linear-gradient(90deg, #8a2be2, #4b0082); height: 100%; border-radius: 8px; width: ${Math.round((stats.financeiro.laboratorioValores.apolo / stats.financeiro.valorTotal) * 100)}%; transition: width 1.5s ease-out;"></div>
                  </div>
                </div>
                <div style="margin-bottom: 10px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span style="font-size: 0.75rem; color: rgba(255,255,255,0.9);">Queiroz</span><span style="font-weight: bold; color: #ff1493; font-size: 0.8rem;">R$ ${stats.financeiro.laboratorioValores.queiroz.toFixed(2)}</span>
                  </div>
                  <div style="background: rgba(255,255,255,0.1); border-radius: 8px; height: 6px; overflow: hidden;">
                    <div class="progress-bar" style="background: linear-gradient(90deg, #ff1493, #ff69b4); height: 100%; border-radius: 8px; width: ${Math.round((stats.financeiro.laboratorioValores.queiroz / stats.financeiro.valorTotal) * 100)}%; transition: width 1.5s ease-out 0.3s;"></div>
                  </div>
                </div>
                <div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span style="font-size: 0.75rem; color: rgba(255,255,255,0.9);">S√£o Louren√ßo</span><span style="font-weight: bold; color: #00bfff; font-size: 0.8rem;">R$ ${stats.financeiro.laboratorioValores.saoLourenco.toFixed(2)}</span>
                  </div>
                  <div style="background: rgba(255,255,255,0.1); border-radius: 8px; height: 6px; overflow: hidden;">
                    <div class="progress-bar" style="background: linear-gradient(90deg, #00bfff, #0080ff); height: 100%; border-radius: 8px; width: ${Math.round((stats.financeiro.laboratorioValores.saoLourenco / stats.financeiro.valorTotal) * 100)}%; transition: width 1.5s ease-out 0.6s;"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Faixa Et√°ria -->
            <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px;">
              <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
                üë∂üë®üë¥ FAIXA ET√ÅRIA
              </h3>
              <div style="display: flex; justify-content: space-around; text-align: center;">
                <div style="flex: 1; padding: 12px; background: rgba(138, 43, 226, 0.15); border-radius: 8px; margin: 0 3px;">
                  <div style="font-size: 1.8rem; font-weight: bold; color: #8a2be2; text-shadow: 0 0 8px rgba(138, 43, 226, 0.4);">${stats.idade.criancas}</div>
                  <div style="font-size: 0.7rem; color: rgba(255,255,255,0.8); text-transform: uppercase;">0-18 anos</div>
                </div>
                <div style="flex: 1; padding: 12px; background: rgba(255, 20, 147, 0.15); border-radius: 8px; margin: 0 3px;">
                  <div style="font-size: 1.8rem; font-weight: bold; color: #ff1493; text-shadow: 0 0 8px rgba(255, 20, 147, 0.4);">${stats.idade.adultos}</div>
                  <div style="font-size: 0.7rem; color: rgba(255,255,255,0.8); text-transform: uppercase;">19-59 anos</div>
                </div>
                <div style="flex: 1; padding: 12px; background: rgba(50, 205, 50, 0.15); border-radius: 8px; margin: 0 3px;">
                  <div style="font-size: 1.8rem; font-weight: bold; color: #32cd32; text-shadow: 0 0 8px rgba(50, 205, 50, 0.4);">${stats.idade.idosos}</div>
                  <div style="font-size: 0.7rem; color: rgba(255,255,255,0.8); text-transform: uppercase;">60+ anos</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Coluna Direita - Top Exames -->
          <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px;">
            <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
              üß™ TOP 15 EXAMES SOLICITADOS
            </h3>
            <div style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
            ${stats.examesMaisSolicitados.map((e, i) => {
              const cores = ['#8a2be2', '#ff1493', '#32cd32', '#00bfff', '#ff69b4', '#ffa500', '#ff6347', '#40e0d0', '#da70d6', '#98fb98', '#f0e68c', '#dda0dd', '#87ceeb', '#f4a460', '#cd853f'];
              const cor = cores[i % cores.length];
              return `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; margin-bottom: 6px; background: rgba(255,255,255,0.05); border-radius: 6px; border-left: 3px solid ${cor};">
                <div style="display: flex; align-items: center;">
                  <span style="background: ${cor}; color: white; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; margin-right: 8px; font-weight: bold;">${i + 1}</span>
                  <span style="font-size: 0.75rem; color: rgba(255,255,255,0.9);">${e.nome}</span>
                </div>
                <span style="font-weight: bold; color: white; font-size: 0.8rem;">${e.count}x</span>
              </div>
            `}).join('')}
            </div>
          </div>
        </div>
        
        <!-- Estat√≠sticas de Pacientes -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
          <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px;">
            <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
              üë§ TOP 15 PACIENTES MAIS RECORRENTES
            </h3>
            <div style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
            ${stats.pacientes.top15Recorrentes.map((p, i) => {
              const cores = ['#ff1493', '#ff69b4', '#da70d6', '#ba55d3', '#9370db', '#8a2be2', '#7b68ee', '#6495ed', '#4169e1', '#0000ff', '#1e90ff', '#00bfff', '#87ceeb', '#87cefa', '#b0e0e6'];
              const cor = cores[i % cores.length];
              return `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; margin-bottom: 6px; background: rgba(255,255,255,0.05); border-radius: 6px; border-left: 3px solid ${cor};">
                <div style="display: flex; align-items: center;">
                  <span style="background: ${cor}; color: white; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; margin-right: 8px; font-weight: bold;">${i + 1}</span>
                  <span style="font-size: 0.75rem; color: rgba(255,255,255,0.9);">${p.cns}</span>
                </div>
                <span style="font-weight: bold; color: white; font-size: 0.8rem;">${p.cadastros}x</span>
              </div>
            `}).join('')}
            </div>
          </div>
          
          <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px;">
            <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
              üß™ TOP 15 PACIENTES COM MAIS EXAMES
            </h3>
            <div style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
            ${stats.pacientes.top15ComMaisExames.map((p, i) => {
              const cores = ['#00bfff', '#1e90ff', '#4169e1', '#0000ff', '#8a2be2', '#9370db', '#ba55d3', '#da70d6', '#ff69b4', '#ff1493', '#dc143c', '#b22222', '#cd5c5c', '#f08080', '#ffa07a'];
              const cor = cores[i % cores.length];
              return `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; margin-bottom: 6px; background: rgba(255,255,255,0.05); border-radius: 6px; border-left: 3px solid ${cor};">
                <div style="display: flex; align-items: center;">
                  <span style="background: ${cor}; color: white; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; margin-right: 8px; font-weight: bold;">${i + 1}</span>
                  <span style="font-size: 0.75rem; color: rgba(255,255,255,0.9);">${p.cns}</span>
                </div>
                <span style="font-weight: bold; color: white; font-size: 0.8rem;">${p.totalExames} exames</span>
              </div>
            `}).join('')}
            </div>
          </div>
        </div>
        
        <!-- Se√ß√£o de Qualidade dos Dados -->
        <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px; margin-top: 20px;">
          <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
            üìä QUALIDADE DOS DADOS DE CONTATO
          </h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
            <div style="padding: 15px; background: rgba(50, 205, 50, 0.15); border-radius: 10px;">
              <div style="font-size: 1.8rem; font-weight: bold; color: #32cd32; margin-bottom: 5px;">${stats.contatos.comTelefone}</div>
              <div style="font-size: 0.7rem; color: rgba(255,255,255,0.8); text-transform: uppercase;">Com Telefone</div>
            </div>
            <div style="padding: 15px; background: rgba(255, 107, 107, 0.15); border-radius: 10px;">
              <div style="font-size: 1.8rem; font-weight: bold; color: #ff6b6b; margin-bottom: 5px;">${stats.contatos.semTelefone}</div>
              <div style="font-size: 0.7rem; color: rgba(255,255,255,0.8); text-transform: uppercase;">Sem Telefone</div>
            </div>
            <div style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
              <div style="font-size: 1.8rem; font-weight: bold; color: ${stats.contatos.percentual >= 80 ? '#32cd32' : stats.contatos.percentual >= 60 ? '#ffa500' : '#ff6b6b'}; margin-bottom: 5px;">${stats.contatos.percentual}%</div>
              <div style="font-size: 0.7rem; color: rgba(255,255,255,0.8); text-transform: uppercase;">Taxa Qualidade</div>
            </div>
          </div>
        </div>
        
        <!-- An√°lises Financeiras Detalhadas -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
          <!-- Valores por Categoria -->
          <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px;">
            <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
              üíä GASTOS POR CATEGORIA
            </h3>
            <div style="max-height: 200px; overflow-y: auto;">
            ${Object.entries(stats.financeiro.categoriaValores).map(([categoria, valor]) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <span style="font-size: 0.8rem; color: rgba(255,255,255,0.9);">${categoria}</span>
                <span style="font-weight: bold; color: #ffd700; font-size: 0.9rem;">R$ ${valor.toFixed(2)}</span>
              </div>
            `).join('')}
            </div>
          </div>
          
          <!-- Top Exames por Valor -->
          <div class="chart-section dark-card" style="padding: 20px; border-radius: 15px;">
            <h3 style="color: white; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;">
              üíé TOP 5 EXAMES MAIS CAROS
            </h3>
            <div>
            ${stats.financeiro.topExamesCaros.map((e, i) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center;">
                  <span style="background: #dc143c; color: white; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; margin-right: 8px; font-weight: bold;">${i + 1}</span>
                  <span style="font-size: 0.7rem; color: rgba(255,255,255,0.9);">${e.nome.substring(0, 25)}...</span>
                </div>
                <span style="font-weight: bold; color: #dc143c; font-size: 0.8rem;">R$ ${e.valor.toFixed(2)}</span>
              </div>
            `).join('')}
            </div>
          </div>
        </div>
      `;
      
    }
    
    function calcularEstatisticas(mesFiltro = 'todos') {
      // Filtrar pacientes por m√™s se especificado
      let pacientesFiltrados = pacientes;
      let mesEspecifico = false;
      if (mesFiltro !== 'todos') {
        mesEspecifico = true;
        const [anoFiltro, mesFiltro2] = mesFiltro.split('-');
        pacientesFiltrados = pacientes.filter(p => {
          if (!p.dataCadastro) return false;
          const partes = p.dataCadastro.split('/');
          if (partes.length !== 3) return false;
          const mes = parseInt(partes[1]).toString().padStart(2, '0');
          const ano = parseInt(partes[2]);
          return ano.toString() === anoFiltro && mes === mesFiltro2;
        });
      }
      const hoje = new Date().toLocaleDateString('pt-BR');
      const mesAtual = new Date().getMonth();
      const anoAtual = new Date().getFullYear();
      
      const stats = {
        total: pacientesFiltrados.length,
        hoje: pacientesFiltrados.filter(p => p.dataCadastro === hoje).length,
        esteMes: pacientesFiltrados.filter(p => {
          const data = new Date(p.dataCadastro.split('/').reverse().join('-'));
          return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
        }).length,
        genero: { masculino: 0, feminino: 0, outros: 0 },
        laboratorio: { apolo: 0, queiroz: 0, saoLourenco: 0 },
        idade: { criancas: 0, adultos: 0, idosos: 0 },
        contatos: { comTelefone: 0, semTelefone: 0 },
        examesMaisSolicitados: [],
        idadeMedia: 0,
        perfilIdade: '',
        crescimento: 0,
        ultimosSete: [],
        tendencia: 0,
        cadastrosMensais: [],
        financeiro: {
          valorTotal: 0,
          gastosMensal: mesEspecifico ? 0 : null,
          valorMedioPaciente: 0,
          exameMaisCaro: { nome: '', valor: 0 },
          exameMaisBarato: { nome: '', valor: 999 },
          laboratorioValores: { apolo: 0, queiroz: 0, saoLourenco: 0 },
          categoriaValores: {},
          topExamesCaros: [],
          topExamesBaratos: []
        },
        pacientes: {
          top15Recorrentes: [],
          top15ComMaisExames: []
        }
      };
      
      const examesCount = {};
      const categoriaValores = {};
      let valorTotalGeral = 0;
      let valorMesAtual = 0;
      let exameMaisCaro = { nome: '', valor: 0 };
      let exameMaisBarato = { nome: '', valor: 999 };
      const examesValores = [];
      
      pacientesFiltrados.forEach(p => {
        // G√™nero
        if (p.genero === 'masculino') stats.genero.masculino++;
        else if (p.genero === 'feminino') stats.genero.feminino++;
        else stats.genero.outros++;
        
        // Laborat√≥rio
        if (p.laboratorio === 'apolo') stats.laboratorio.apolo++;
        else if (p.laboratorio === 'queiroz') stats.laboratorio.queiroz++;
        else if (p.laboratorio === 'sao_lourenco') stats.laboratorio.saoLourenco++;
        
        // Idade
        if (p.dataNascimento) {
          const idade = new Date().getFullYear() - new Date(p.dataNascimento).getFullYear();
          if (idade <= 18) stats.idade.criancas++;
          else if (idade <= 59) stats.idade.adultos++;
          else stats.idade.idosos++;
        }
        
        // Contatos
        if (p.telefone && p.telefone.trim()) stats.contatos.comTelefone++;
        else stats.contatos.semTelefone++;
        
        // Exames e c√°lculos financeiros
        let valorPaciente = 0;
        if (p.exames && Array.isArray(p.exames)) {
          p.exames.forEach(exame => {
            examesCount[exame.texto] = (examesCount[exame.texto] || 0) + 1;
            
            // Buscar valor do exame
            let valorExame = 0;
            let categoriaExame = '';
            Object.keys(examesDisponiveis).forEach(categoria => {
              const exameEncontrado = examesDisponiveis[categoria].find(e => 
                exame.texto.includes(e.codigo) || exame.valor === e.codigo
              );
              if (exameEncontrado) {
                valorExame = exameEncontrado.valor;
                categoriaExame = categoria;
              }
            });
            
            valorPaciente += valorExame;
            valorTotalGeral += valorExame;
            
            // Verificar se √© do m√™s atual
            const dataPaciente = new Date(p.dataCadastro.split('/').reverse().join('-'));
            if (dataPaciente.getMonth() === mesAtual && dataPaciente.getFullYear() === anoAtual) {
              valorMesAtual += valorExame;
            }
            
            // Atualizar valores por categoria
            if (categoriaExame) {
              categoriaValores[categoriaExame] = (categoriaValores[categoriaExame] || 0) + valorExame;
            }
            
            // Atualizar valores por laborat√≥rio
            if (valorExame > 0) {
              if (p.laboratorio === 'apolo') stats.financeiro.laboratorioValores.apolo += valorExame;
              else if (p.laboratorio === 'queiroz') stats.financeiro.laboratorioValores.queiroz += valorExame;
              else if (p.laboratorio === 'sao_lourenco') stats.financeiro.laboratorioValores.saoLourenco += valorExame;
            }
            
            // Verificar exame mais caro e mais barato
            if (valorExame > 0) {
              examesValores.push({ nome: exame.texto, valor: valorExame });
              if (valorExame > exameMaisCaro.valor) {
                exameMaisCaro = { nome: exame.texto, valor: valorExame };
              }
              if (valorExame < exameMaisBarato.valor) {
                exameMaisBarato = { nome: exame.texto, valor: valorExame };
              }
            }
          });
        }
      });
      
      // Percentuais de g√™nero
      stats.genero.masculinoPerc = Math.round((stats.genero.masculino / stats.total) * 100);
      stats.genero.femininoPerc = Math.round((stats.genero.feminino / stats.total) * 100);
      
      // Percentual de contatos
      stats.contatos.percentual = Math.round((stats.contatos.comTelefone / stats.total) * 100);
      
      // Top 15 exames
      stats.examesMaisSolicitados = Object.entries(examesCount)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 15)
        .map(([nome, count]) => ({ nome, count }));
      
      // Finalizar c√°lculos financeiros
      stats.financeiro.valorTotal = valorTotalGeral;
      if (mesEspecifico) {
        stats.financeiro.gastosMensal = valorTotalGeral;
      }
      stats.financeiro.valorMedioPaciente = stats.total > 0 ? valorTotalGeral / stats.total : 0;
      stats.financeiro.exameMaisCaro = exameMaisCaro.valor > 0 ? exameMaisCaro : { nome: 'N/A', valor: 0 };
      stats.financeiro.exameMaisBarato = exameMaisBarato.valor < 999 ? exameMaisBarato : { nome: 'N/A', valor: 0 };
      stats.financeiro.categoriaValores = categoriaValores;
      
      // Top 5 exames mais caros e mais baratos
      const examesOrdenados = examesValores.sort((a, b) => b.valor - a.valor);
      stats.financeiro.topExamesCaros = examesOrdenados.slice(0, 5);
      stats.financeiro.topExamesBaratos = examesOrdenados.slice(-5).reverse();
      
      // Calcular pacientes mais recorrentes e com mais exames
      const cnsCount = {};
      const cnsExames = {};
      
      pacientesFiltrados.forEach(p => {
        if (p.cpf) {
          // Contar cadastros por CNS
          cnsCount[p.cpf] = (cnsCount[p.cpf] || 0) + 1;
          
          // Contar exames por CNS
          const totalExamesPaciente = p.exames ? p.exames.length : 0;
          if (!cnsExames[p.cpf] || cnsExames[p.cpf] < totalExamesPaciente) {
            cnsExames[p.cpf] = totalExamesPaciente;
          }
        }
      });
      
      // Top 15 pacientes mais recorrentes
      stats.pacientes.top15Recorrentes = Object.entries(cnsCount)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 15)
        .map(([cns, count]) => ({ cns, cadastros: count }));
      
      // Top 15 pacientes com mais exames
      stats.pacientes.top15ComMaisExames = Object.entries(cnsExames)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 15)
        .map(([cns, count]) => ({ cns, totalExames: count }));
      
      // Idade m√©dia e perfil
      let somaIdades = 0;
      let countIdades = 0;
      pacientesFiltrados.forEach(p => {
        if (p.dataNascimento) {
          const idade = new Date().getFullYear() - new Date(p.dataNascimento).getFullYear();
          somaIdades += idade;
          countIdades++;
        }
      });
      stats.idadeMedia = countIdades > 0 ? Math.round(somaIdades / countIdades) : 0;
      stats.perfilIdade = stats.idadeMedia <= 25 ? 'Jovem' : stats.idadeMedia <= 45 ? 'Adulto' : stats.idadeMedia <= 65 ? 'Maduro' : 'S√™nior';
      
      // √öltimos 7 dias
      const ultimosSete = [];
      for (let i = 6; i >= 0; i--) {
        const data = new Date();
        data.setDate(data.getDate() - i);
        const dataStr = data.toLocaleDateString('pt-BR');
        const count = pacientes.filter(p => p.dataCadastro === dataStr).length;
        ultimosSete.push({
          dia: data.toLocaleDateString('pt-BR', { weekday: 'short' }),
          count: count
        });
      }
      stats.ultimosSete = ultimosSete;
      
      // Tend√™ncia (compara√ß√£o √∫ltimos 3 dias vs 3 anteriores)
      const ultimos3 = ultimosSete.slice(-3).reduce((sum, dia) => sum + dia.count, 0);
      const anteriores3 = ultimosSete.slice(-6, -3).reduce((sum, dia) => sum + dia.count, 0);
      stats.tendencia = anteriores3 > 0 ? ((ultimos3 - anteriores3) / anteriores3) * 100 : 0;
      
      // Cadastros mensais (√∫ltimos 12 meses)
      const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
      const cadastrosMensais = [];
      
      // Debug: verificar datas dos pacientes
      console.log('Datas de cadastro dos pacientes:', pacientes.map(p => p.dataCadastro));
      
      for (let i = 11; i >= 0; i--) {
        const dataReferencia = new Date();
        dataReferencia.setMonth(dataReferencia.getMonth() - i);
        const mesReferencia = dataReferencia.getMonth();
        const anoReferencia = dataReferencia.getFullYear();
        
        console.log(`Verificando m√™s: ${meses[mesReferencia]}/${anoReferencia}`);
        
        const count = pacientes.filter(p => {
          if (!p.dataCadastro) return false;
          try {
            // Tratar formato brasileiro dd/mm/aaaa
            const partes = p.dataCadastro.split('/');
            if (partes.length === 3) {
              const dia = parseInt(partes[0]);
              const mes = parseInt(partes[1]) - 1; // JavaScript usa 0-11 para meses
              const ano = parseInt(partes[2]);
              
              const dataPaciente = new Date(ano, mes, dia);
              const mesMatch = dataPaciente.getMonth() === mesReferencia;
              const anoMatch = dataPaciente.getFullYear() === anoReferencia;
              
              if (mesMatch && anoMatch) {
                console.log(`Paciente encontrado: ${p.nome} - ${p.dataCadastro}`);
              }
              
              return mesMatch && anoMatch;
            }
            return false;
          } catch (error) {
            console.error('Erro ao processar data:', p.dataCadastro, error);
            return false;
          }
        }).length;
        
        console.log(`${meses[mesReferencia]}: ${count} cadastros`);
        
        cadastrosMensais.push({
          mes: meses[mesReferencia],
          count: count
        });
      }
      stats.cadastrosMensais = cadastrosMensais;
      
      console.log('Cadastros mensais final:', cadastrosMensais);
      
      // Crescimento mensal (compara√ß√£o com m√™s anterior)
      const mesAtualCount = cadastrosMensais[cadastrosMensais.length - 1]?.count || 0;
      const mesAnteriorCount = cadastrosMensais[cadastrosMensais.length - 2]?.count || 0;
      stats.crescimento = mesAnteriorCount > 0 ? ((mesAtualCount - mesAnteriorCount) / mesAnteriorCount) * 100 : 0;
      
      return stats;
    }
    
    function fecharEstatisticas() {
      document.getElementById('modalEstatisticas').style.display = 'none';
    }
    
    function imprimirDashboard() {
      // Criar uma nova janela para impress√£o
      const printWindow = window.open('', '_blank');
      const mesSelecionado = document.getElementById('mesFiltro').value;
      const stats = calcularEstatisticas(mesSelecionado);
      
      // Determinar t√≠tulo baseado no filtro
      let tituloFiltro = '';
      if (mesSelecionado !== 'todos') {
        const [ano, mes] = mesSelecionado.split('-');
        const mesesNomes = ['', 'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        tituloFiltro = ` - ${mesesNomes[parseInt(mes)]} ${ano}`;
      }
      
      const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Dashboard SCEL${tituloFiltro} - ${new Date().toLocaleDateString('pt-BR')}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: Arial, sans-serif; font-size: 9px; line-height: 1.2; padding: 10px; }
            h1 { text-align: center; margin-bottom: 12px; font-size: 14px; }
            h2 { font-size: 10px; margin-bottom: 6px; border-bottom: 1px solid #333; padding-bottom: 2px; }
            .grid { display: grid; gap: 8px; margin-bottom: 12px; }
            .grid-5 { grid-template-columns: 1fr 1fr 1fr 1fr 1fr; }
            .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
            .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
            .grid-2 { grid-template-columns: 1fr 1fr; }
            .card { border: 1px solid #333; padding: 6px; text-align: center; background: #f8f9fa; }
            .metric { font-size: 14px; font-weight: bold; margin-bottom: 2px; }
            .label { font-size: 7px; text-transform: uppercase; }
            .chart-container { border: 1px solid #ddd; padding: 6px; margin-bottom: 8px; }
            .exame-list { font-size: 7px; line-height: 1.2; }
            .exame-item { display: flex; justify-content: space-between; padding: 1px 0; border-bottom: 1px dotted #ccc; }
            .bar-chart { display: flex; align-items: end; height: 25px; gap: 1px; margin: 3px 0; overflow: hidden; }
            .bar { background: #333; width: 8px; margin: 0 1px; max-height: 20px; }
            .bar-label { font-size: 6px; text-align: center; margin-top: 1px; }
            .bar-container { display: flex; flex-direction: column; align-items: center; flex: 1; }
            .financial { background: #fff3cd; border: 1px solid #ffeaa7; }
          </style>
        </head>
        <body>
          <h1>üè• DASHBOARD ACOMPANHAMENTO SCEL${tituloFiltro} - ${new Date().toLocaleDateString('pt-BR')}</h1>
          
          <!-- M√©tricas Principais -->
          <div class="grid grid-5">
            <div class="card">
              <div class="metric">${stats.total}</div>
              <div class="label">Total Pacientes</div>
            </div>
            <div class="card">
              <div class="metric">${stats.hoje}</div>
              <div class="label">Hoje</div>
            </div>
            <div class="card">
              <div class="metric">${stats.esteMes}</div>
              <div class="label">Este M√™s</div>
            </div>
            <div class="card">
              <div class="metric">${stats.contatos.percentual}%</div>
              <div class="label">Taxa Contato</div>
            </div>
            <div class="card financial">
              <div class="metric">R$ ${stats.financeiro.valorTotal.toFixed(2)}</div>
              <div class="label">Valor Total</div>
            </div>
          </div>
          
          <!-- M√©tricas Financeiras -->
          <div class="grid ${stats.financeiro.gastosMensal !== null ? 'grid-4' : 'grid-3'}">
            ${stats.financeiro.gastosMensal !== null ? `
            <div class="card financial">
              <div class="metric">R$ ${stats.financeiro.gastosMensal.toFixed(2)}</div>
              <div class="label">Gastos Mensais</div>
            </div>` : ''}
            <div class="card financial">
              <div class="metric">R$ ${stats.financeiro.valorMedioPaciente.toFixed(2)}</div>
              <div class="label">M√©dia/Paciente</div>
            </div>
            <div class="card financial">
              <div class="metric">R$ ${stats.financeiro.exameMaisCaro.valor.toFixed(2)}</div>
              <div class="label">Exame Mais Caro</div>
            </div>
            <div class="card financial">
              <div class="metric">R$ ${stats.financeiro.exameMaisBarato.valor.toFixed(2)}</div>
              <div class="label">Exame Mais Barato</div>
            </div>
          </div>
          
          <!-- Cadastros Mensais -->
          <div class="chart-container">
            <h2>Cadastros Mensais</h2>
            <div class="bar-chart">
              ${(() => {
                const maxCount = Math.max(...stats.cadastrosMensais.map(m => m.count), 1);
                return stats.cadastrosMensais.map(m => {
                  const altura = Math.max((m.count / maxCount) * 25, 2);
                  return `
                    <div class="bar-container">
                      <div class="bar" style="height: ${altura}px;"></div>
                      <div class="bar-label">${m.mes}</div>
                      <div class="bar-label">${m.count}</div>
                    </div>
                  `;
                }).join('');
              })()}
            </div>
          </div>
          
          <!-- An√°lises -->
          <div class="grid grid-3">
            <div class="chart-container">
              <h2>Por G√™nero</h2>
              <div>Masculino: ${stats.genero.masculino} (${stats.genero.masculinoPerc}%)</div>
              <div>Feminino: ${stats.genero.feminino} (${stats.genero.femininoPerc}%)</div>
              ${stats.genero.outros > 0 ? `<div>Outros: ${stats.genero.outros}</div>` : ''}
            </div>
            
            <div class="chart-container financial">
              <h2>Gastos por Laborat√≥rio</h2>
              <div>Apolo: R$ ${stats.financeiro.laboratorioValores.apolo.toFixed(2)}</div>
              <div>Queiroz: R$ ${stats.financeiro.laboratorioValores.queiroz.toFixed(2)}</div>
              <div>S√£o Louren√ßo: R$ ${stats.financeiro.laboratorioValores.saoLourenco.toFixed(2)}</div>
            </div>
            
            <div class="chart-container">
              <h2>Faixa Et√°ria</h2>
              <div>0-18 anos: ${stats.idade.criancas}</div>
              <div>19-59 anos: ${stats.idade.adultos}</div>
              <div>60+ anos: ${stats.idade.idosos}</div>
            </div>
          </div>
          
          <!-- An√°lises Detalhadas -->
          <div class="grid grid-2">
            <div class="chart-container">
              <h2>Top 10 Exames Mais Solicitados</h2>
              <div class="exame-list">
                ${stats.examesMaisSolicitados.slice(0, 10).map((e, i) => `
                  <div class="exame-item">
                    <span>${i + 1}. ${e.nome.substring(0, 30)}...</span>
                    <span>${e.count}x</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="chart-container financial">
              <h2>Gastos por Categoria</h2>
              <div class="exame-list">
                ${Object.entries(stats.financeiro.categoriaValores).map(([categoria, valor]) => `
                  <div class="exame-item">
                    <span>${categoria}</span>
                    <span>R$ ${valor.toFixed(2)}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          
          <!-- Top Exames por Valor -->
          <div class="chart-container financial">
            <h2>Top 5 Exames Mais Caros</h2>
            <div class="exame-list">
              ${stats.financeiro.topExamesCaros.map((e, i) => `
                <div class="exame-item">
                  <span>${i + 1}. ${e.nome.substring(0, 40)}...</span>
                  <span>R$ ${e.valor.toFixed(2)}</span>
                </div>
              `).join('')}
            </div>
          </div>
          
          <!-- Top 15 Pacientes -->
          <div class="grid grid-2">
            <div class="chart-container">
              <h2>Top 10 Pacientes Mais Recorrentes</h2>
              <div class="exame-list">
                ${stats.pacientes.top15Recorrentes.slice(0, 10).map((p, i) => `
                  <div class="exame-item">
                    <span>${i + 1}. ${p.cns}</span>
                    <span>${p.cadastros}x</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="chart-container">
              <h2>Top 10 Pacientes com Mais Exames</h2>
              <div class="exame-list">
                ${stats.pacientes.top15ComMaisExames.slice(0, 10).map((p, i) => `
                  <div class="exame-item">
                    <span>${i + 1}. ${p.cns}</span>
                    <span>${p.totalExames} exames</span>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          
          <!-- Resumo Final -->
          <div class="grid grid-4">
            <div class="card">
              <div class="metric">${stats.contatos.comTelefone}</div>
              <div class="label">Com Telefone</div>
            </div>
            <div class="card">
              <div class="metric">${stats.contatos.semTelefone}</div>
              <div class="label">Sem Telefone</div>
            </div>
            <div class="card">
              <div class="metric">${stats.contatos.percentual}%</div>
              <div class="label">Taxa Qualidade</div>
            </div>
            <div class="card financial">
              <div class="metric">${stats.crescimento.toFixed(1)}%</div>
              <div class="label">Crescimento</div>
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 20px; font-size: 8px; color: #666;">
            Gerado em: ${new Date().toLocaleString('pt-BR')} | Sistema SCEL
          </div>
        </body>
        </html>
      `;
      
      printWindow.document.write(printContent);
      printWindow.document.close();
      
      // Aguardar carregamento e imprimir
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
        }, 500);
      };
    }

    // Atalhos de teclado
    document.addEventListener('keydown', function(e) {
      // Ctrl + S = Salvar/Cadastrar
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        const form = document.getElementById('pacienteForm');
        if (form) form.dispatchEvent(new Event('submit'));
      }
      
      // Ctrl + E = Exportar
      if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        exportarExcel();
      }
      
      // Ctrl + D = Dashboard
      if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        abrirEstatisticas();
      }
      
      // ESC = Fechar modais
      if (e.key === 'Escape') {
        const modals = ['modalExames', 'modalEstatisticas', 'modalEdicao', 'modalAjuda', 'modalManual'];
        modals.forEach(modalId => {
          const modal = document.getElementById(modalId);
          if (modal && modal.style.display === 'block') {
            modal.style.display = 'none';
          }
        });
        document.getElementById('historicoCns').style.display = 'none';
      }
      
      // F3 = Focar na busca
      if (e.key === 'F3') {
        e.preventDefault();
        document.getElementById('busca').focus();
      }
    });
    
    // Fun√ß√£o de ajuda com modal
    function mostrarAjuda() {
      document.getElementById('modalAjuda').style.display = 'block';
    }
    
    function fecharModalAjuda() {
      document.getElementById('modalAjuda').style.display = 'none';
    }
    
    function abrirManualCompleto() {
      document.getElementById('modalAjuda').style.display = 'none';
      document.getElementById('modalManual').style.display = 'block';
    }
    
    function fecharModalManual() {
      document.getElementById('modalManual').style.display = 'none';
    }
    
    function scrollToSection(sectionId) {
      const element = document.getElementById(sectionId);
      if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
    
    // Fechar modal e hist√≥rico clicando fora
    window.onclick = function(event) {
      const modalEdicao = document.getElementById('modalEdicao');
      const modalEstatisticas = document.getElementById('modalEstatisticas');
      const historicoCns = document.getElementById('historicoCns');
      
      if (event.target === modalEdicao) {
        fecharModal();
      } else if (event.target === modalEstatisticas) {
        fecharEstatisticas();
      } else if (!event.target.closest('#cpf') && !event.target.closest('#historicoCns')) {
        historicoCns.style.display = 'none';
      }
    }
  </script>
</body>
</html>